Folder: src

    Folder: app
        File: favicon.ico
            [Could not read file: 'utf-8' codec can't decode byte 0x96 in position 50: invalid start byte]
        File: globals.css
            Code:
            @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700;800&display=swap');
            
            /* --- Reset & Base --- */
            * { box-sizing: border-box; margin: 0; padding: 0; }
            body {
                font-family: 'Heebo', sans-serif;
                overflow: hidden; 
                user-select: none;
                height: 100vh;
                width: 100vw;
                color: white;
                background: #1a1a2e; /* Fallback */
            }
            
            /* --- Scrollbar Styling --- */
            ::-webkit-scrollbar { width: 6px; }
            ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
            ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
            ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
            
            /* --- Utility Classes --- */
            .hidden { display: none !important; }
            
            /* --- Background Animation (Upgraded - Fluid Motion) --- */
            .wallpaper-bg {
                position: fixed;
                top: 0; left: 0; width: 100%; height: 100%;
                background: linear-gradient(125deg, #2c3e50, #000000, #2980b9, #8e44ad, #1a1a2e);
                background-size: 400% 400%;
                animation: gradient-flow 30s ease infinite;
                z-index: -1;
            }
            
            .wallpaper-bg::after {
                content: '';
                position: absolute;
                top: 0; left: 0; width: 100%; height: 100%;
                background: radial-gradient(circle at 50% 50%, rgba(76, 209, 55, 0.1), transparent 70%),
                            radial-gradient(circle at 80% 20%, rgba(155, 89, 182, 0.1), transparent 60%);
                mix-blend-mode: screen;
                animation: pulse 12s ease-in-out infinite alternate;
            }
            
            /* ×× ×™××¦×™×” ×¨× ×“×•××œ×™×ª ×•× ×¢×™××” ×™×•×ª×¨ */
            @keyframes gradient-flow {
                0% { background-position: 0% 50%; }
                25% { background-position: 50% 100%; }
                50% { background-position: 100% 50%; }
                75% { background-position: 50% 0%; }
                100% { background-position: 0% 50%; }
            }
            
            @keyframes pulse {
                0% { opacity: 0.4; transform: scale(1); }
                100% { opacity: 0.8; transform: scale(1.05); }
            }
            
            /* --- Layout --- */
            .main-container {
                position: absolute;
                right: 40px; 
                top: 50%;
                transform: translateY(-50%);
                display: flex;
                gap: 24px;
                height: 85vh;
                align-items: stretch;
                direction: rtl; /* Ensure RTL layout for the container */
            }
            
            /* --- Glassmorphism Components --- */
            .glass-panel {
                background: rgba(16, 18, 27, 0.75);
                backdrop-filter: blur(20px);
                -webkit-backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.12);
                box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.45);
                border-radius: 24px;
                padding: 24px;
                display: flex;
                flex-direction: column;
            }
            
            /* --- Ticker Column (Right) --- */
            .ticker-col {
                width: 260px;
                gap: 16px;
                overflow-y: auto;
            }
            
            .coin-card {
                background: rgba(255, 255, 255, 0.05);
                padding: 16px;
                border-radius: 16px;
                display: flex;
                justify-content: space-between;
                align-items: center;
                transition: background 0.2s, border-color 0.2s; 
                border-right: 4px solid transparent;
            }
            .coin-card:hover { 
                background: rgba(255, 255, 255, 0.12); 
            }
            
            .coin-info h3 { font-size: 1.1rem; font-weight: 700; margin: 0; }
            .coin-info span { font-size: 0.8rem; opacity: 0.7; }
            .coin-price { text-align: left; }
            .price-val { font-size: 1rem; font-weight: bold; font-family: monospace; letter-spacing: 1px; }
            
            .up { color: #00ff88; }
            .down { color: #ff4d4d; }
            .border-up { border-right-color: #00ff88; }
            .border-down { border-right-color: #ff4d4d; }
            
            /* --- Main Content Column (Left) --- */
            .calc-col {
                width: 550px;
                position: relative;
            }
            
            /* --- Tabs --- */
            .tabs-container {
                display: flex;
                background: rgba(0,0,0,0.3);
                border-radius: 12px;
                padding: 4px;
                margin-bottom: 20px;
                gap: 5px;
                overflow-x: auto;
            }
            .tab-btn {
                background: transparent;
                border: none;
                color: rgba(255,255,255,0.6);
                padding: 10px 10px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: bold;
                transition: background 0.2s, color 0.2s;
                font-family: inherit;
                flex: 1;
                white-space: nowrap;
                font-size: 0.9rem;
            }
            .tab-btn:hover { color: white; background: rgba(255,255,255,0.08); }
            .tab-btn.active {
                background: #00b894;
                color: white;
                box-shadow: 0 4px 10px rgba(0, 184, 148, 0.3);
            }
            
            /* --- Content Areas --- */
            .tab-content {
                flex: 1;
                overflow-y: auto;
                padding-right: 5px;
                height: 100%;
            }
            
            /* --- Shortcuts Styling --- */
            .shortcuts-grid {
                display: grid;
                grid-template-columns: 1fr;
                gap: 12px;
            }
            .shortcut-card {
                background: rgba(255,255,255,0.05);
                border-radius: 12px;
                padding: 12px 16px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                transition: background 0.2s; 
                border: 1px solid rgba(255,255,255,0.05);
            }
            .shortcut-card:hover {
                background: rgba(255,255,255,0.1);
            }
            .key-combo {
                display: flex;
                gap: 6px;
                align-items: center;
                direction: ltr;
            }
            .key {
                background: linear-gradient(180deg, #4b4b4b, #2a2a2a);
                border: 1px solid #111;
                border-bottom: 3px solid #111;
                border-radius: 6px;
                padding: 4px 10px;
                font-family: monospace;
                font-weight: bold;
                font-size: 0.9rem;
                color: #eee;
                box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            }
            .shortcut-desc {
                font-size: 0.9rem;
                opacity: 0.9;
                text-align: right;
                padding-right: 15px;
            }
            
            /* --- Inputs --- */
            .input-group { margin-bottom: 12px; }
            .input-group label { display: block; font-size: 0.85rem; margin-bottom: 6px; opacity: 0.8; text-align: right; }
            .glass-input {
                width: 100%;
                background: rgba(255, 255, 255, 0.08);
                border: 1px solid rgba(255, 255, 255, 0.15);
                padding: 12px;
                border-radius: 12px;
                color: white;
                font-size: 1.1rem;
                outline: none;
                font-family: monospace;
                text-align: left;
                direction: ltr;
                transition: border-color 0.2s, background 0.2s;
            }
            .glass-input:focus { border-color: #00b894; background: rgba(255, 255, 255, 0.12); }
            
            select.glass-input {
                appearance: none;
                background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23FFFFFF%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
                background-repeat: no-repeat;
                background-position: left 12px top 50%;
                background-size: 12px auto;
            }
            option { background: #1a1a2e; color: white; }
            
            /* --- Calculator UI --- */
            .calc-header { text-align: center; margin-bottom: 25px; }
            .calc-header h2 { font-size: 2.2rem; margin-bottom: 5px; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
            .calc-header p { opacity: 0.7; font-size: 1rem; letter-spacing: 0.5px; }
            
            .coin-select-row {
                display: flex;
                justify-content: center;
                gap: 12px;
                margin-bottom: 25px;
            }
            .coin-btn {
                background: rgba(255,255,255,0.1);
                border: 1px solid rgba(255,255,255,0.1);
                padding: 8px 20px;
                border-radius: 25px;
                color: white;
                cursor: pointer;
                font-weight: 700;
                font-size: 0.9rem;
                transition: all 0.2s;
            }
            .coin-btn:hover { background: rgba(255,255,255,0.2); }
            .coin-btn.active { background: rgba(0, 184, 148, 0.2); border-color: #00b894; color: #00b894; box-shadow: 0 0 15px rgba(0,184,148,0.1); }
            
            .mode-toggle {
                display: flex;
                background: #0b0e14;
                border-radius: 12px;
                padding: 4px;
                margin-bottom: 25px;
            }
            .mode-btn {
                flex: 1;
                padding: 12px;
                border: none;
                background: transparent;
                color: #888;
                font-weight: 800;
                border-radius: 10px;
                cursor: pointer;
                transition: 0.2s;
                font-size: 1rem;
                display: flex;
                align-items: center;
                justify-content: center;
                gap: 8px;
            }
            .mode-btn.long.active { background: #00b894; color: white; box-shadow: 0 2px 10px rgba(0,184,148,0.2); }
            .mode-btn.short.active { background: #ff7675; color: white; box-shadow: 0 2px 10px rgba(255,118,117,0.2); }
            
            .calc-result-box {
                background: #0b0e14;
                border-radius: 16px;
                padding: 25px;
                margin-top: 25px;
                border: 1px solid rgba(255,255,255,0.05);
            }
            .res-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px dashed rgba(255,255,255,0.2); }
            .res-main-val { color: #f1c40f; font-size: 2.2rem; font-weight: 800; font-family: monospace; line-height: 1; margin-bottom: 5px; }
            .res-sub-val { font-size: 1.1rem; font-weight: 600; opacity: 0.9; font-family: monospace; letter-spacing: 1px; }
            .res-label { font-size: 0.85rem; opacity: 0.6; margin-bottom: 4px; display: block; }
            
            .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
            .res-item-small .val { font-size: 1.3rem; font-weight: 700; font-family: monospace; }
            
            /* --- Strategy Card Styling --- */
            .strategy-card {
                background: rgba(0,0,0,0.3);
                border: 1px solid rgba(255,255,255,0.1);
                border-radius: 16px;
                padding: 16px;
                margin-bottom: 20px;
                position: relative;
                direction: rtl;
            }
            .strategy-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-bottom: 1px solid rgba(255,255,255,0.1);
                padding-bottom: 10px;
                margin-bottom: 10px;
            }
            .badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
            .badge-long { background: rgba(0, 184, 148, 0.2); color: #00b894; }
            .badge-short { background: rgba(255, 118, 117, 0.2); color: #ff7675; }
            
            .data-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.95rem; }
            .val-profit { color: #00b894; font-weight: bold; }
            .val-loss { color: #ff7675; font-weight: bold; }
            
            .sub-card {
                background: rgba(255,255,255,0.05);
                border-radius: 10px;
                padding: 12px;
                margin-top: 12px;
                border-right: 3px solid #ff7675;
            }
            
            .total-pnl-box {
                margin-top: 15px;
                padding-top: 12px;
                border-top: 1px dashed rgba(255,255,255,0.3);
                text-align: center;
            }
            .big-pnl { font-size: 1.6rem; font-weight: 800; text-shadow: 0 0 15px rgba(0,0,0,0.5); font-family: monospace; }
            
            .btn-action {
                width: 100%;
                padding: 10px;
                margin-top: 10px;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 700;
                font-size: 0.95rem;
                transition: background 0.2s, transform 0.1s;
            }
            .btn-add-spot { background: #6c5ce7; color: white; }
            .btn-add-spot:hover { background: #5649c0; }
            .btn-add-short { background: rgba(255, 118, 117, 0.15); color: #ff7675; border: 1px solid rgba(255, 118, 117, 0.5); }
            .btn-add-short:hover { background: rgba(255, 118, 117, 0.25); }
            
            /* ×›×¤×ª×•×¨×™ ×¢×¨×™×›×” ×•××—×™×§×” */
            .icon-btn { 
                background: transparent; 
                border: none; 
                font-size: 1.1rem; 
                cursor: pointer; 
                padding: 0 6px; 
                opacity: 0.7; 
                transition: 0.2s; 
            }
            .icon-btn:hover { opacity: 1; transform: scale(1.1); }
            .btn-delete { color: #ff7675; }
            .btn-delete:hover { color: #ff4d4d; }
            .btn-edit { color: #74b9ff; }
            .btn-edit:hover { color: #0984e3; }
            
            .projection-box {
                font-size: 0.85rem;
                background: rgba(0,0,0,0.4);
                padding: 10px;
                border-radius: 8px;
                margin-top: 10px;
            }
            
            /* --- Lock Screen Styles --- */
            .lock-container {
                text-align: center;
                padding: 40px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100%;
            }
            .lock-icon { font-size: 3rem; margin-bottom: 20px; color: #ff7675; }
            .lock-input { 
                text-align: center; 
                letter-spacing: 5px; 
                font-size: 1.5rem; 
                width: 200px;
            }
            
            /* --- Modal Styling --- */
            .modal-overlay {
                position: fixed;
                top: 0; left: 0;
                width: 100%; height: 100%;
                background: rgba(0,0,0,0.6);
                z-index: 100;
                backdrop-filter: blur(5px);
            }
            
            .modal-content {
                background: #151922;
                border: 1px solid rgba(255,255,255,0.15);
                box-shadow: 0 20px 50px rgba(0,0,0,0.8);
                position: fixed;
                top: 50%;
                left: 35%; /* ×”×•×–×– ×©×××œ×” ×‘××§×•× 50% */
                transform: translate(-50%, -50%);
                z-index: 200;
                width: 360px;
                /* display is handled by React conditional rendering */
            }
            
            /* Confim Modal Center */
            .modal-content.confirm-modal {
                left: 50%;
                width: 300px;
                text-align: center;
            }
            
            .investment-highlight {
                background: rgba(108, 92, 231, 0.1);
                border: 1px solid rgba(108, 92, 231, 0.3);
                padding: 10px;
                border-radius: 8px;
                margin-top: 10px;
                text-align: center;
            }
            .investment-val {
                color: #a29bfe;
                font-weight: 800;
                font-size: 1.2rem;
                font-family: monospace;
            }
            .profit-highlight {
                 background: rgba(0, 184, 148, 0.1);
                 border: 1px solid rgba(0, 184, 148, 0.3);
                 padding: 10px;
                 border-radius: 8px;
                 margin-top: 10px;
                 text-align: center;
            }
            .profit-val {
                 color: #55efc4;
                 font-weight: 800;
                 font-size: 1.2rem;
                 font-family: monospace;
            }
        File: layout.tsx
            Code:
            import type { Metadata } from "next";
            import { Geist, Geist_Mono } from "next/font/google";
            import "./globals.css";
            
            const geistSans = Geist({
              variable: "--font-geist-sans",
              subsets: ["latin"],
            });
            
            const geistMono = Geist_Mono({
              variable: "--font-geist-mono",
              subsets: ["latin"],
            });
            
            export const metadata: Metadata = {
              title: "Create Next App",
              description: "Generated by create next app",
            };
            
            export default function RootLayout({
              children,
            }: Readonly<{
              children: React.ReactNode;
            }>) {
              return (
                <html lang="en">
                  <body className={`${geistSans.variable} ${geistMono.variable}`}>
                    {children}
                  </body>
                </html>
              );
            }
        File: page.module.css
            Code:
            .page {
              --background: #fafafa;
              --foreground: #fff;
            
              --text-primary: #000;
              --text-secondary: #666;
            
              --button-primary-hover: #383838;
              --button-secondary-hover: #f2f2f2;
              --button-secondary-border: #ebebeb;
            
              display: flex;
              min-height: 100vh;
              align-items: center;
              justify-content: center;
              font-family: var(--font-geist-sans);
              background-color: var(--background);
            }
            
            .main {
              display: flex;
              min-height: 100vh;
              width: 100%;
              max-width: 800px;
              flex-direction: column;
              align-items: flex-start;
              justify-content: space-between;
              background-color: var(--foreground);
              padding: 120px 60px;
            }
            
            .intro {
              display: flex;
              flex-direction: column;
              align-items: flex-start;
              text-align: left;
              gap: 24px;
            }
            
            .intro h1 {
              max-width: 320px;
              font-size: 40px;
              font-weight: 600;
              line-height: 48px;
              letter-spacing: -2.4px;
              text-wrap: balance;
              color: var(--text-primary);
            }
            
            .intro p {
              max-width: 440px;
              font-size: 18px;
              line-height: 32px;
              text-wrap: balance;
              color: var(--text-secondary);
            }
            
            .intro a {
              font-weight: 500;
              color: var(--text-primary);
            }
            
            .ctas {
              display: flex;
              flex-direction: row;
              width: 100%;
              max-width: 440px;
              gap: 16px;
              font-size: 14px;
            }
            
            .ctas a {
              display: flex;
              justify-content: center;
              align-items: center;
              height: 40px;
              padding: 0 16px;
              border-radius: 128px;
              border: 1px solid transparent;
              transition: 0.2s;
              cursor: pointer;
              width: fit-content;
              font-weight: 500;
            }
            
            a.primary {
              background: var(--text-primary);
              color: var(--background);
              gap: 8px;
            }
            
            a.secondary {
              border-color: var(--button-secondary-border);
            }
            
            /* Enable hover only on non-touch devices */
            @media (hover: hover) and (pointer: fine) {
              a.primary:hover {
                background: var(--button-primary-hover);
                border-color: transparent;
              }
            
              a.secondary:hover {
                background: var(--button-secondary-hover);
                border-color: transparent;
              }
            }
            
            @media (max-width: 600px) {
              .main {
                padding: 48px 24px;
              }
            
              .intro {
                gap: 16px;
              }
            
              .intro h1 {
                font-size: 32px;
                line-height: 40px;
                letter-spacing: -1.92px;
              }
            }
            
            @media (prefers-color-scheme: dark) {
              .logo {
                filter: invert();
              }
            
              .page {
                --background: #000;
                --foreground: #000;
            
                --text-primary: #ededed;
                --text-secondary: #999;
            
                --button-primary-hover: #ccc;
                --button-secondary-hover: #1a1a1a;
                --button-secondary-border: #1a1a1a;
              }
            }
        File: page.tsx
            Code:
            // tradewall\src\app\page.tsx
            
            'use client';
            
            import React, { useState, useEffect } from 'react';
            import { supabase } from '../lib/supabaseClient';
            import LiveTicker, { TickerItem } from '../components/LiveTicker';
            import RiskCalculator from '../components/RiskCalculator';
            import KeyboardShortcuts from '../components/KeyboardShortcuts';
            import AuthModal from '../components/AuthModal';
            import PositionModal, { Position } from '../components/PositionModal'; 
            
            type Portfolio = {
                [key: string]: Position[];
            };
            
            type Prices = {
                [key: string]: number;
            };
            
            // --- Constants ---
            const SECRET_PIN = process.env.NEXT_PUBLIC_SECRET_PIN || "050488";
            const FINNHUB_API_KEY = process.env.NEXT_PUBLIC_FINNHUB_API_KEY || ""; 
            
            export default function TradeWall() {
                // --- State ---
                const [tickers, setTickers] = useState<TickerItem[]>([]); 
                const [prices, setPrices] = useState<Prices>({});
                const [activeTab, setActiveTab] = useState<string>('calc');
            
                // User / Auth State
                const [user, setUser] = useState<any>(null);
                const [showAuthModal, setShowAuthModal] = useState(false);
            
                // Portfolio Data
                const [portfolio, setPortfolio] = useState<Portfolio>({});
                const [isLoadingData, setIsLoadingData] = useState(true);
            
                // Alerts Refresh Trigger
                const [refreshTrigger, setRefreshTrigger] = useState(0);
            
                // Lock Screen State
                const [isLocked, setIsLocked] = useState(false);
                const [lockPin, setLockPin] = useState('');
            
                // --- Modal Configuration State ---
                const [modalConfig, setModalConfig] = useState<{
                    isOpen: boolean;
                    mode: 'add' | 'edit';
                    coin: string;
                    parentIdx: number | null;
                    childIdx: number | null;
                }>({
                    isOpen: false,
                    mode: 'add',
                    coin: '',
                    parentIdx: null,
                    childIdx: null
                });
            
                // Delete Confirmation State
                const [deleteModal, setDeleteModal] = useState<{
                    isOpen: boolean;
                    type: 'spot' | 'short' | null;
                    coin: string;
                    index: number | null;
                    shortIndex: number | null;
                }>({ isOpen: false, type: null, coin: '', index: null, shortIndex: null });
            
                // --- Helpers for Persistence ---
                const updateLockState = (locked: boolean) => {
                    setIsLocked(locked);
                    if (typeof window !== 'undefined') {
                        localStorage.setItem('tradeWall_isLocked', locked.toString());
                    }
                };
            
                // --- Fetch Logic (Reused) ---
            
                // ×¤×•× ×§×¦×™×” ×œ×©×œ×™×¤×ª ×˜×™×§×¨×™× - ××•×’×“×¨×ª ×›××Ÿ ×›×“×™ ×©× ×•×›×œ ×œ×”×¢×‘×™×¨ ××•×ª×” ×œ-LiveTicker
                const fetchTickers = async () => {
                    if (!user) {
                        setTickers([]);
                        return;
                    }
            
                    const { data, error } = await supabase
                        .from('tickers')
                        .select('*')
                        .eq('is_active', true)
                        .eq('user_id', user.id)
                        .order('symbol', { ascending: true });
                    
                    if (data) {
                        setTickers(data as TickerItem[]);
                        
                        // ××ª×—×•×œ ××—×™×¨×™× ×”×ª×—×œ×ª×™×™× ×œ-0 ×¢×‘×•×¨ ×˜×™×§×¨×™× ×—×“×©×™× (×ª×•×š ×©××™×¨×” ×¢×œ ××—×™×¨×™× ×§×™×™××™×)
                        setPrices(prev => {
                            const newPrices = { ...prev };
                            data.forEach((t: any) => {
                                if (newPrices[t.symbol] === undefined) {
                                    newPrices[t.symbol] = 0;
                                }
                            });
                            return newPrices;
                        });
                    }
                };
            
                // --- Effects ---
            
                // 1. Check User Session on Mount & Listen for Auth Changes
                useEffect(() => {
                    const getUser = async () => {
                        const { data: { session } } = await supabase.auth.getSession();
                        setUser(session?.user || null);
                        if (session?.user) {
                            fetchPortfolio(session.user.id);
                        } else {
                            fetchPortfolio(null);
                        }
                    };
                    getUser();
            
                    const { data: { subscription } } = supabase.auth.onAuthStateChange((_event, session) => {
                        setUser(session?.user || null);
                        if (!session) {
                            setPortfolio({});
                            setTickers([]); 
                        } else {
                            fetchPortfolio(session.user.id);
                        }
                    });
            
                    return () => subscription.unsubscribe();
                }, []);
            
                // 2. Fetch Tickers when user changes
                useEffect(() => {
                    fetchTickers();
                }, [user]);
            
                // 3. WebSocket (Crypto) & Stock API Integration
                useEffect(() => {
                    if (typeof window !== 'undefined') {
                        const savedLockState = localStorage.getItem('tradeWall_isLocked');
                        if (savedLockState === 'true') {
                            setIsLocked(true);
                        }
                    }
            
                    let ws: WebSocket | null = null;
                    let reconnectTimer: NodeJS.Timeout | null = null;
                    let stockInterval: NodeJS.Timeout | null = null;
            
                    // --- ×¤×•× ×§×¦×™×” ×œ×—×™×‘×•×¨ ×•×•×‘×¡×•×§×˜ ×§×¨×™×¤×˜×• (×‘×™× × ×¡) ---
                    const connectWebSocket = () => {
                        const cryptoSymbols = tickers.filter(t => t.type === 'crypto').map(t => t.symbol.toLowerCase() + 'usdt');
                        
                        if (cryptoSymbols.length === 0) return;
            
                        // ×©×™××•×© ×‘-Combined Streams
                        const streams = cryptoSymbols.map(s => `${s}@miniTicker`).join('/');
                        const url = `wss://stream.binance.com:9443/stream?streams=${streams}`;
            
                        if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                            return;
                        }
            
                        console.log('Connecting to Binance WebSocket...');
                        
                        try {
                            ws = new WebSocket(url);
            
                            ws.onopen = () => {
                                console.log('WebSocket Connected');
                            };
            
                            ws.onmessage = (event) => {
                                try {
                                    const message = JSON.parse(event.data);
                                    // ×‘-Combined Stream, ×”××™×“×¢ × ××¦× ×ª×—×ª ×”××¤×ª×— 'data'
                                    const data = message.data || message; 
            
                                    if (data && data.s && data.c) {
                                        const symbol = data.s.replace('USDT', '');
                                        const price = parseFloat(data.c);
                                        setPrices(prev => ({ ...prev, [symbol]: price }));
                                    }
                                } catch (e) {
                                    // ×”×ª×¢×œ××•×ª ××©×’×™××•×ª ×¤×¨×¡×•×¨ ×‘×•×“×“×•×ª
                                }
                            };
            
                            ws.onclose = () => {
                                console.log('WebSocket Closed. Reconnecting in 3s...');
                                reconnectTimer = setTimeout(connectWebSocket, 3000);
                            };
            
                            ws.onerror = (err) => {
                                console.warn('WebSocket Connection Error (Retrying...)');
                                ws?.close();
                            };
                        } catch (e) {
                            console.error("Failed to create WebSocket:", e);
                        }
                    };
            
                    // --- ×¤×•× ×§×¦×™×” ×œ××©×™×›×ª ××—×™×¨×™ ×× ×™×•×ª (Finnhub API) ---
                    const fetchStockPrices = async () => {
                        const stocks = tickers.filter(t => t.type === 'stock');
                        if (stocks.length === 0) return;
            
                        if (!FINNHUB_API_KEY) {
                            console.warn("Missing Finnhub API Key");
                            return;
                        }
            
                        const promises = stocks.map(async (stock) => {
                            try {
                                const res = await fetch(`https://finnhub.io/api/v1/quote?symbol=${stock.symbol}&token=${FINNHUB_API_KEY}`);
                                if (!res.ok) return null;
                                const data = await res.json();
                                return { symbol: stock.symbol, price: data.c }; 
                            } catch (error) {
                                console.error(`Error fetching ${stock.symbol}:`, error);
                                return null;
                            }
                        });
            
                        const results = await Promise.all(promises);
                        
                        const newStockPrices: Prices = {};
                        results.forEach(item => {
                            if (item && item.price) {
                                newStockPrices[item.symbol] = parseFloat(item.price);
                            }
                        });
                        
                        if (Object.keys(newStockPrices).length > 0) {
                            setPrices(prev => ({ ...prev, ...newStockPrices }));
                        }
                    };
            
                    if (tickers.length > 0) {
                        connectWebSocket();
                        fetchStockPrices();
                        stockInterval = setInterval(fetchStockPrices, 15000); 
                    }
            
                    const handleVisibilityChange = () => {
                        if (document.visibilityState === 'visible') {
                            if (!ws || ws.readyState === WebSocket.CLOSED || ws.readyState === WebSocket.CLOSING) {
                                if (reconnectTimer) clearTimeout(reconnectTimer);
                                connectWebSocket();
                            }
                        }
                    };
            
                    document.addEventListener('visibilitychange', handleVisibilityChange);
            
                    return () => {
                        document.removeEventListener('visibilitychange', handleVisibilityChange);
                        if (reconnectTimer) clearTimeout(reconnectTimer);
                        if (ws) ws.close();
                        if (stockInterval) clearInterval(stockInterval);
                    };
                }, [tickers]); 
            
                // --- Helpers & Supabase Logic ---
            
                const fetchPortfolio = async (userId: string | null) => {
                    setIsLoadingData(true);
                    
                    let query = supabase
                        .from('positions')
                        .select('*')
                        .order('created_at', { ascending: true });
            
                    if (userId) {
                        query = query.eq('user_id', userId);
                    } else {
                         query = query.is('user_id', null);
                    }
            
                    const { data, error } = await query;
            
                    if (error) {
                        console.error('Error fetching data:', error);
                        setIsLoadingData(false);
                        return;
                    }
            
                    if (data) {
                        const newPortfolio: Portfolio = {};
                        tickers.forEach(t => newPortfolio[t.symbol] = []);
            
                        const spots = data.filter(item => item.parent_id === null);
                        spots.forEach(spot => {
                            if (!newPortfolio[spot.symbol]) newPortfolio[spot.symbol] = [];
                            
                            newPortfolio[spot.symbol].push({
                                ...spot, 
                                entry: Number(spot.entry),
                                amount: Number(spot.amount),
                                tp: Number(spot.tp),
                                sl: Number(spot.sl),
                                risk: Number(spot.risk),
                                shorts: []
                            });
                        });
            
                        const shorts = data.filter(item => item.parent_id !== null);
                        shorts.forEach(short => {
                            const coin = short.symbol;
                            if (newPortfolio[coin]) {
                                const parentSpot = newPortfolio[coin].find(p => p.id === short.parent_id);
                                if (parentSpot) {
                                    parentSpot.shorts.push({
                                        ...short,
                                        entry: Number(short.entry),
                                        amount: Number(short.amount),
                                        tp: Number(short.tp),
                                        sl: Number(short.sl),
                                        risk: Number(short.risk),
                                        shorts: []
                                    });
                                }
                            }
                        });
            
                        setPortfolio(newPortfolio);
                    }
                    setIsLoadingData(false);
                };
            
                // ×¢×“×›×•×Ÿ ×”×¤×•×¨×˜×¤×•×œ×™×• ×›××©×¨ ×”×˜×™×§×¨×™× ××©×ª× ×™×
                useEffect(() => {
                    if (user) fetchPortfolio(user.id);
                }, [tickers]);
            
            
                // --- Helpers for Modal ---
            
                const openModal = (mode: 'add' | 'edit', coin: string, parentIdx: number | null = null, childIdx: number | null = null) => {
                    if (!user) {
                        setShowAuthModal(true);
                        return;
                    }
                    setModalConfig({
                        isOpen: true,
                        mode,
                        coin,
                        parentIdx,
                        childIdx
                    });
                };
            
                const confirmDelete = async () => {
                    const { type, coin, index, shortIndex } = deleteModal;
                    try {
                        let idToDelete = '';
                        
                        if (type === 'spot' && index !== null) {
                            idToDelete = portfolio[coin][index].id;
                        } else if (type === 'short' && index !== null && shortIndex !== null) {
                            idToDelete = portfolio[coin][index].shorts[shortIndex].id;
                        }
            
                        if (!idToDelete) return;
            
                        const { error } = await supabase.from('positions').delete().eq('id', idToDelete);
                        if (error) throw error;
            
                        if (type === 'spot') {
                            await supabase.from('alerts').delete()
                                .eq('coin', coin)
                                .eq('user_id', user.id);
                            setRefreshTrigger(prev => prev + 1);
                        } else {
                            const currentHedgeNum = (shortIndex ?? 0) + 1;
                            const nextHedgeNum = currentHedgeNum + 1;
            
                            const { data: alerts } = await supabase.from('alerts').select('id, note').eq('coin', coin).eq('user_id', user.id);
                            
                            if (alerts) {
                                const idsToDelete = alerts
                                    .filter(a => {
                                        if (!a.note) return false;
                                        const relatedToCurrent = a.note.includes(`Hedge ${currentHedgeNum}`);
                                        const relatedToNextEntry = a.note.includes(`ENTER HEDGE ${nextHedgeNum}`);
                                        return relatedToCurrent || relatedToNextEntry;
                                    })
                                    .map(a => a.id);
                                
                                if (idsToDelete.length > 0) {
                                    await supabase.from('alerts').delete().in('id', idsToDelete);
                                    setRefreshTrigger(prev => prev + 1);
                                }
                            }
                        }
            
                        await fetchPortfolio(user ? user.id : null);
                        setDeleteModal({ isOpen: false, type: null, coin: '', index: null, shortIndex: null });
            
                    } catch (err: any) {
                        alert("×©×’×™××” ×‘××—×™×§×”: " + err.message);
                    }
                };
            
                // --- Renderers ---
            
                const renderCategoryHub = (type: 'crypto' | 'stock') => {
                    const items = tickers.filter(t => t.type === type);
                    return (
                        <div className="tab-content active" style={{ direction: 'rtl' }}>
                            <div className="calc-header">
                                <h2>{type === 'crypto' ? '×¤×•×¨×˜×¤×•×œ×™×• ×§×¨×™×¤×˜×•' : '×¤×•×¨×˜×¤×•×œ×™×• ×× ×™×•×ª'}</h2>
                                <p>×‘×—×¨ × ×›×¡ ×œ×¦×¤×™×™×” ×•× ×™×”×•×œ ×¤×•×–×™×¦×™×•×ª</p>
                            </div>
                            <div className="shortcuts-grid">
                                {items.map(t => (
                                    <div key={t.symbol} className="shortcut-card" onClick={() => setActiveTab(t.symbol)} style={{cursor: 'pointer', justifyContent: 'center', flexDirection: 'column', gap: 5}}>
                                        <h3 style={{fontSize: '1.2rem', fontWeight: 'bold'}}>{t.symbol}</h3>
                                        <span style={{opacity: 0.7}}>{t.name}</span>
                                        <span style={{
                                            color: (prices[t.symbol] || 0) > 0 ? '#00ff88' : 'white', 
                                            fontSize: '1.1rem', fontWeight: 'bold', fontFamily: 'monospace'
                                        }}>
                                            ${prices[t.symbol]?.toLocaleString(undefined, {minimumFractionDigits: 2}) || 'Loading...'}
                                        </span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    );
                };
            
                const renderPortfolio = () => {
                    if (isLocked) {
                        return (
                            <div className="lock-container">
                                <div className="lock-icon">ğŸ”’</div>
                                <h3 style={{ marginBottom: 20 }}>×”×¤×•×¨×˜×¤×•×œ×™×• × ×¢×•×œ</h3>
                                <input type="password" value={lockPin} onChange={e => setLockPin(e.target.value)}
                                    className="glass-input lock-input" placeholder="****" maxLength={6} />
                                <button onClick={() => { if (lockPin === SECRET_PIN) { updateLockState(false); setLockPin(''); } else alert('×¡×™×¡××” ×©×’×•×™×”!'); }}
                                    className="btn-action btn-add-spot" style={{ width: 200, marginTop: 20 }}>×¤×ª×™×—×”</button>
                            </div>
                        );
                    }
            
                    const strategies = portfolio[activeTab] || [];
                    const currentPrice = prices[activeTab] || 0;
            
                    if (isLoadingData) return <div style={{ textAlign: 'center', padding: 40, opacity: 0.8 }}>×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>;
                    if (!user && strategies.length === 0) return <div style={{ textAlign: 'center', padding: 40, opacity: 0.8 }}><p style={{fontSize:'1.1rem', marginBottom:15}}>× × ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ× ×”×œ ×¤×•×–×™×¦×™×•×ª</p><button className="btn-action" style={{background:'#6c5ce7', color:'white', width:150}} onClick={() => setShowAuthModal(true)}>×”×ª×—×‘×¨×•×ª</button></div>;
                    
                    if (strategies.length === 0) return (
                        <div style={{ textAlign: 'center', padding: 40, opacity: 0.5 }}>
                            <h2 style={{marginBottom: 10}}>{activeTab}</h2>
                            <p style={{ fontSize: '1.2rem', marginBottom: 20 }}>××™×Ÿ ×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª</p>
                            <button className="btn-action btn-add-spot" style={{ width: 200 }} onClick={() => openModal('add', activeTab)}>+ ×¤×ª×— ×¤×•×–×™×¦×™×™×ª ×¡×¤×•×˜</button>
                        </div>
                    );
            
                    return (
                        <div className="tab-content active" style={{ direction: 'rtl', paddingLeft: '12px' }}>
                            <div style={{ marginBottom: 20, display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                <div style={{display:'flex', gap: 10, alignItems:'center'}}>
                                     <button onClick={() => {
                                         const type = tickers.find(t => t.symbol === activeTab)?.type;
                                         setActiveTab(type === 'stock' ? 'stock_hub' : 'crypto_hub');
                                     }} style={{background:'transparent', border:'none', color:'white', fontSize:'1.2rem', cursor:'pointer'}}>âœ</button>
                                     <h2 style={{margin:0}}>{activeTab}</h2>
                                </div>
                                
                                <div style={{display:'flex', gap: 10}}>
                                    <button className="icon-btn" onClick={() => updateLockState(true)} title="× ×¢×œ ××¡×š">ğŸ”’</button>
                                    <button className="btn-action btn-add-spot" style={{ width: 'auto', padding: '8px 20px' }} onClick={() => openModal('add', activeTab)}>+ ×”×•×¡×£ ×¡×¤×•×˜</button>
                                </div>
                            </div>
            
                            {strategies.map((spot, idx) => {
                                const spotValue = spot.amount * currentPrice;
                                const spotCost = spot.amount * spot.entry;
                                const spotPnL = spotValue - spotCost;
                                let totalShortPnL = 0;
            
                                const projectedSpotWin = (spot.tp - spot.entry) * spot.amount;
                                let projectedShortLossAtTP = 0;
                                let projectedShortWinAtSL = 0;
            
                                spot.shorts.forEach(s => {
                                    const shortPnL = (s.entry - currentPrice) * s.amount;
                                    totalShortPnL += shortPnL;
                                    if (spot.tp) projectedShortLossAtTP += (s.entry - spot.tp) * s.amount;
                                    if (spot.sl) projectedShortWinAtSL += (s.entry - spot.sl) * s.amount;
                                });
            
                                const netAtTP = projectedSpotWin + projectedShortLossAtTP;
                                const netAtSL = (spot.sl ? (spot.sl - spot.entry) * spot.amount : 0) + projectedShortWinAtSL;
            
                                return (
                                    <div key={idx} className="strategy-card">
                                        <div className="strategy-header">
                                            <div style={{ display: 'flex', flexDirection: 'column' }}>
                                                <span className="badge badge-long" style={{ fontSize: '0.9rem' }}>SPOT LONG ({spot.currency || 'USDT'})</span>
                                                {spot.trade_date && <span style={{ fontSize: '0.75rem', opacity: 0.6, marginTop: 4 }}>{spot.trade_date} {spot.trade_time}</span>}
                                            </div>
                                            <div>
                                                <button className="icon-btn btn-edit" onClick={() => openModal('edit', activeTab, idx)}>âœ</button>
                                                <button className="icon-btn btn-delete" onClick={() => setDeleteModal({ isOpen: true, type: 'spot', coin: activeTab, index: idx, shortIndex: null })}>ğŸ—‘</button>
                                            </div>
                                        </div>
            
                                        <div className="data-row">
                                            <span>×›× ×™×¡×”: <strong>${spot.entry}</strong></span>
                                            <span>×™×¢×“: <span style={{ color: '#00b894' }}>{spot.tp ? `$${spot.tp}` : '-'}</span></span>
                                        </div>
                                        <div className="data-row">
                                            <span>×›××•×ª: {spot.amount}</span>
                                            <span>×¡×˜×•×¤: <span style={{ color: '#ff7675' }}>{spot.sl ? `$${spot.sl}` : '-'}</span></span>
                                        </div>
                                         <div className="data-row">
                                            <span>×”×©×§×¢×”: ${spotCost.toFixed(2)}</span>
                                            <span>×¡×™×›×•×Ÿ: {spot.risk ? `$${spot.risk}` : '-'}</span>
                                        </div>
                                        <div className="data-row">
                                            <span>PNL ×¡×¤×•×˜:</span>
                                            <span className={spotPnL >= 0 ? 'val-profit' : 'val-loss'}>{spotPnL >= 0 ? '+' : ''}${spotPnL.toFixed(2)}</span>
                                        </div>
            
                                        {spot.shorts.map((short, sIdx) => {
                                            const shortPnL = (short.entry - currentPrice) * short.amount;
                                            return (
                                                <div key={sIdx} className="sub-card">
                                                    <div className="strategy-header" style={{ marginBottom: 8, border: 'none', padding: 0 }}>
                                                        <div style={{ display: 'flex', flexDirection: 'column' }}>
                                                            <span className="badge badge-short">Hedge {sIdx + 1} ({short.currency || 'USDT'})</span>
                                                            {short.trade_date && <span style={{ fontSize: '0.7rem', opacity: 0.6 }}>{short.trade_date} {short.trade_time}</span>}
                                                        </div>
                                                        <div>
                                                            <button className="icon-btn btn-edit" onClick={() => openModal('edit', activeTab, idx, sIdx)}>âœ</button>
                                                            <button className="icon-btn btn-delete" onClick={() => setDeleteModal({ isOpen: true, type: 'short', coin: activeTab, index: idx, shortIndex: sIdx })}>Ã—</button>
                                                        </div>
                                                    </div>
                                                    <div className="data-row">
                                                        <span>×›× ×™×¡×”: ${short.entry}</span>
                                                        <span>×›××•×ª: {short.amount}</span>
                                                    </div>
                                                    <div className="data-row" style={{ fontSize: '0.85rem', opacity: 0.8 }}>
                                                        <span>TP: {short.tp || '-'}</span>
                                                        <span>SL: {short.sl || '-'}</span>
                                                    </div>
                                                    <div className="data-row">
                                                        <span>×¨×•×•×—/×”×¤×¡×“:</span>
                                                        <span className={shortPnL >= 0 ? 'val-profit' : 'val-loss'}>{shortPnL >= 0 ? '+' : ''}${shortPnL.toFixed(2)}</span>
                                                    </div>
                                                </div>
                                            )
                                        })}
            
                                        {spot.shorts.length < 4 && (
                                            <button className="btn-action btn-add-short" onClick={() => openModal('add', activeTab, idx)}>+ ×”×•×¡×£ ×’×™×“×•×¨ (Short)</button>
                                        )}
            
                                        {(spot.tp || spot.sl) && (
                                            <div className="projection-box">
                                                <div><strong>×ª×—×–×™×ª (PNL ××©×•×¢×¨):</strong></div>
                                                {spot.tp > 0 && (
                                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 6 }}>
                                                        <span>×‘-TP (${spot.tp}):</span>
                                                        <span style={{ color: netAtTP >= 0 ? '#00ff88' : '#ff4d4d' }}>{netAtTP >= 0 ? '+' : ''}${netAtTP.toFixed(2)}</span>
                                                    </div>
                                                )}
                                                {spot.sl > 0 && (
                                                    <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                                        <span>×‘-SL (${spot.sl}):</span>
                                                        <span style={{ color: netAtSL >= 0 ? '#00ff88' : '#ff4d4d' }}>{netAtSL >= 0 ? '+' : ''}${netAtSL.toFixed(2)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        )}
            
                                        <div className="total-pnl-box">
                                            <div style={{ fontSize: '0.9rem', marginBottom: 5 }}>×¡×”"×› ×¨×•×•×—/×”×¤×¡×“ ××¡×˜×¨×˜×’×™×”:</div>
                                            <div className={`big-pnl ${(spotPnL + totalShortPnL) >= 0 ? 'val-profit' : 'val-loss'}`}>
                                                {(spotPnL + totalShortPnL) >= 0 ? '+' : ''}${(spotPnL + totalShortPnL).toFixed(2)}
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    );
                };
            
                return (
                    <main>
                        <div className="wallpaper-bg"></div>
                        <div className="main-container">
                            <LiveTicker
                                prices={prices}
                                onCoinClick={(coin) => { setActiveTab(coin); }}
                                userId={user?.id || null}
                                refreshTrigger={refreshTrigger}
                                tickers={tickers}
                                onTickerUpdate={fetchTickers}
                            />
                            <div className="glass-panel calc-col">
                                <div style={{display:'flex', justifyContent:'space-between', alignItems:'center', marginBottom:15}}>
                                    <div style={{fontSize:'0.9rem', opacity:0.8}}>
                                        {user ? (<span>××—×•×‘×¨: <span style={{color:'#00b894', fontWeight:'bold'}}>{user.email?.split('@')[0]}</span></span>) : (<span>××•×¨×—</span>)}
                                    </div>
                                    <div>
                                        {user ? (
                                            <button onClick={async () => { await supabase.auth.signOut(); }} className="btn-action" style={{background:'transparent', border:'1px solid rgba(255,255,255,0.2)', padding:'4px 12px', fontSize:'0.8rem', width:'auto'}}>×”×ª× ×ª×§</button>
                                        ) : (
                                            <button onClick={() => setShowAuthModal(true)} className="btn-action" style={{background:'#6c5ce7', padding:'4px 12px', fontSize:'0.8rem', width:'auto'}}>×”×ª×—×‘×¨/×”×¨×©×</button>
                                        )}
                                    </div>
                                </div>
            
                                <div className="tabs-container">
                                    <button className={`tab-btn ${activeTab === 'calc' ? 'active' : ''}`} onClick={() => setActiveTab('calc')}>××—×©×‘×•×Ÿ</button>
                                    <button className={`tab-btn ${activeTab === 'shortcuts' ? 'active' : ''}`} onClick={() => setActiveTab('shortcuts')}>×§×™×¦×•×¨×™×</button>
                                    
                                    {/* ×›×¤×ª×•×¨ ×§×¨×™×¤×˜×• - ××¦×™×’ ××ª ×›×œ ××˜×‘×¢×•×ª ×”×§×¨×™×¤×˜×• */}
                                    <button className={`tab-btn ${activeTab === 'crypto_hub' || tickers.find(t => t.symbol === activeTab && t.type === 'crypto') ? 'active' : ''}`} 
                                            onClick={() => setActiveTab('crypto_hub')}>
                                        ×§×¨×™×¤×˜×•
                                    </button>
                                    
                                    {/* ×›×¤×ª×•×¨ ×× ×™×•×ª */}
                                    <button className={`tab-btn ${activeTab === 'stock_hub' || tickers.find(t => t.symbol === activeTab && t.type === 'stock') ? 'active' : ''}`} 
                                            onClick={() => setActiveTab('stock_hub')}>
                                        ×× ×™×•×ª
                                    </button>
                                </div>
            
                                {activeTab === 'calc' && <RiskCalculator prices={prices} />}
                                {activeTab === 'shortcuts' && <KeyboardShortcuts />}
                                
                                {activeTab === 'crypto_hub' && renderCategoryHub('crypto')}
                                {activeTab === 'stock_hub' && renderCategoryHub('stock')}
                                
                                {tickers.find(t => t.symbol === activeTab) && renderPortfolio()}
                            </div>
                        </div>
            
                        <AuthModal isOpen={showAuthModal} onClose={() => setShowAuthModal(false)} />
            
                        {/* ×”×©×™××•×© ×‘×§×•××¤×•× × ×˜×” ×”×—×“×©×” */}
                        <PositionModal
                            isOpen={modalConfig.isOpen}
                            onClose={() => setModalConfig({ ...modalConfig, isOpen: false })}
                            mode={modalConfig.mode}
                            coin={modalConfig.coin}
                            currentPrice={prices[modalConfig.coin]}
                            user={user}
                            // ×©×œ×™×¤×ª ××•×‘×™×™×§×˜ ×”×¡×¤×•×˜ ×”××‘, ×× ×§×™×™× ××™× ×“×§×¡
                            parentSpot={(modalConfig.coin && modalConfig.parentIdx !== null && portfolio[modalConfig.coin]) 
                                ? portfolio[modalConfig.coin][modalConfig.parentIdx] 
                                : null
                            }
                            // ×©×œ×™×¤×ª ××•×‘×™×™×§×˜ ×”×’×™×“×•×¨ ×”×‘×Ÿ, ×× ×§×™×™× ××™× ×“×§×¡
                            childHedge={(modalConfig.coin && modalConfig.parentIdx !== null && modalConfig.childIdx !== null && portfolio[modalConfig.coin])
                                ? portfolio[modalConfig.coin][modalConfig.parentIdx].shorts[modalConfig.childIdx]
                                : null
                            }
                            childHedgeIndex={modalConfig.childIdx}
                            onSuccess={(refreshAlerts) => {
                                fetchPortfolio(user ? user.id : null);
                                if (refreshAlerts) {
                                    setRefreshTrigger(prev => prev + 1);
                                }
                            }}
                        />
            
                        {deleteModal.isOpen && (
                            <>
                                <div className="modal-overlay" onClick={() => setDeleteModal({ ...deleteModal, isOpen: false })}></div>
                                <div className="glass-panel modal-content confirm-modal">
                                    <h3>××—×™×§×ª ×¤×•×–×™×¦×™×”</h3>
                                    <p>×”×× ×œ××—×•×§ ××ª ×”×¤×•×–×™×¦×™×” ×•××ª ×”×”×ª×¨××•×ª ×©×œ×”?</p>
                                    <div style={{ display: 'flex', gap: 10, marginTop:20 }}>
                                        <button onClick={confirmDelete} className="btn-action" style={{ background: '#ff4d4d' }}>××—×§</button>
                                        <button onClick={() => setDeleteModal({ ...deleteModal, isOpen: false })} className="btn-action" style={{ background: '#333' }}>×‘×™×˜×•×œ</button>
                                    </div>
                                </div>
                            </>
                        )}
                    </main>
                );
            }

        Folder: api

            Folder: pushover
                File: route.ts
                    Code:
                    // tradewall\src\app\api\pushover\route.ts
                    
                    import { NextResponse } from 'next/server';
                    
                    export async function POST(request: Request) {
                      try {
                        const { message, title } = await request.json();
                    
                        const userKey = process.env.PUSHOVER_USER_KEY;
                        const token = process.env.PUSHOVER_API_TOKEN;
                    
                        if (!userKey || !token) {
                          return NextResponse.json({ error: 'Missing Pushover keys in .env.local' }, { status: 500 });
                        }
                    
                        // ×‘× ×™×™×ª ×”××™×“×¢ ×œ×©×œ×™×—×” ×œ×¤×™ ×”×“×•×§×•×× ×˜×¦×™×” (application/x-www-form-urlencoded)
                        const formData = new URLSearchParams();
                        formData.append('token', token);
                        formData.append('user', userKey);
                        formData.append('message', message);
                        if (title) formData.append('title', title);
                    
                        // ×©×œ×™×—×ª ×”×‘×§×©×” ×œ-Pushover
                        const res = await fetch('https://api.pushover.net/1/messages.json', {
                          method: 'POST',
                          headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                          },
                          body: formData,
                        });
                    
                        const data = await res.json();
                    
                        if (!res.ok || data.status !== 1) {
                          throw new Error(data.errors ? data.errors.join(', ') : 'Failed to send notification');
                        }
                    
                        return NextResponse.json({ success: true, request: data.request });
                      } catch (error: any) {
                        console.error('Pushover Error:', error.message);
                        return NextResponse.json({ error: error.message || 'Internal Server Error' }, { status: 500 });
                      }
                    }

        Folder: utils
            File: hedgeLogic.ts
                Code:
                // src/app/utils/hedgeLogic.ts
                
                export interface HedgeSetup {
                    index: number;         // ××¡×¤×¨ ×”×’×™×“×•×¨ (1, 2, 3...)
                    entry: number;         // ××—×™×¨ ×›× ×™×¡×”
                    tp: number;           // ×˜×™×™×§ ×¤×¨×•×¤×™×˜ (×™×—×¡ 1:1 ×œ×¡×™×›×•×Ÿ)
                    sl: number;           // ×¡×˜×•×¤ ×œ×•×¡ (×§×‘×•×¢, ×©×•×•×” ×œ-Spot TP)
                    riskAmount: number;    // ×›××” ×“×•×œ×¨×™× ××¡×›× ×™× ×‘×¤×•×–×™×¦×™×” ×”×–×•
                    potentialProfit: number; // ×¨×•×•×— ×¤×•×˜× ×¦×™××œ×™ (×× ××’×™×¢ ×œ-TP)
                    coinAmount: number;    // ×›××” ××˜×‘×¢×•×ª ×¦×¨×™×š ×œ×§× ×•×ª ×›×“×™ ×œ×¢××•×“ ×‘×¡×™×›×•×Ÿ
                    investAmount: number;  // ×¡×”"×› ×“×•×œ×¨×™× ×œ×”×©×§×¢×” (Entry * CoinAmount)
                }
                
                /**
                 * ××—×©×‘ ××¡×˜×¨×˜×’×™×™×ª ×’×™×“×•×¨ ××“×•×¨×’×ª (Layered Hedge Strategy)
                 * @param spotEntry ××—×™×¨ ×›× ×™×¡×” ×œ×¡×¤×•×˜ (××©××© ×œ×—×™×©×•×‘ ×‘×¡×™×¡ ×”×¨×•×•×—)
                 * @param spotTP ××—×™×¨ ×™×¢×“ ×œ×¡×¤×•×˜ / ×¡×˜×•×¤ ×œ×’×™×“×•×¨ (××©××© ×œ×—×™×©×•×‘ ×¨×•×•×— ×•×’× ×›×’×‘×•×œ ×¢×œ×™×•×Ÿ)
                 * @param spotAmount ×›××•×ª ××˜×‘×¢×•×ª ×‘×¡×¤×•×˜
                 * @param riskPercent ××—×•×– ×”×¡×™×›×•×Ÿ ×”×¨×¦×•×™ ××ª×•×š ×”×¨×•×•×— ×”×¤×•×˜× ×¦×™××œ×™ (×œ××©×œ 50 ××• 0.5)
                 * @param hedgesCount ××¡×¤×¨ ×”×’×™×“×•×¨×™× ×”×¨×¦×•×™ (2, 3, 4)
                 * @param customStrategyStart (××•×¤×¦×™×•× ×œ×™) ××—×™×¨ ×”×ª×—×œ×” ×™×“× ×™ ×œ×’×™×“×•×¨ ×”×¨××©×•×Ÿ. ×× ×œ× ×¡×•×¤×§, ×™×œ×§×— ×”-spotEntry
                 */
                export function calculateHedgeStrategy(
                    spotEntry: number,
                    spotTP: number,
                    spotAmount: number,
                    riskPercent: number, 
                    hedgesCount: number,
                    customStrategyStart?: number
                ): HedgeSetup[] {
                    
                    // × ×¨××•×œ ×”××—×•×– (×× ×”×ª×§×‘×œ 50, × ×”×¤×•×š ×œ-0.5)
                    const normalizedPercent = riskPercent > 1 ? riskPercent / 100 : riskPercent;
                
                    // 1. ×—×™×©×•×‘ ×”×¨×•×•×— ×”×¤×•×˜× ×¦×™××œ×™ ×©×œ ×”×¡×¤×•×˜ (×”×‘×¡×™×¡ ×œ×ª×§×¦×™×‘ ×”×¡×™×›×•×Ÿ)
                    // ×”×ª×§×¦×™×‘ ×ª××™×“ × ×’×–×¨ ××”×¤×•×–×™×¦×™×” ×”××§×•×¨×™×ª
                    const spotPotentialProfit = Math.abs(spotTP - spotEntry) * spotAmount;
                    
                    // 2. ×—×™×©×•×‘ ×¡×š ×ª×§×¦×™×‘ ×”×¡×™×›×•×Ÿ ×œ×›×œ ×”×’×™×“×•×¨×™× ×™×—×“
                    const totalRiskBudget = spotPotentialProfit * normalizedPercent;
                    
                    // 3. ×¡×™×›×•×Ÿ ×¤×¨ ×’×™×“×•×¨ ×‘×•×“×“ (×—×œ×•×§×” ×©×•×•×”)
                    const riskPerHedge = totalRiskBudget / hedgesCount;
                    
                    // × ×§×•×“×ª ×”×”×ª×—×œ×” ×©×œ ×¨×©×ª ×”×’×™×“×•×¨×™× (×”××©×ª××© ×™×›×•×œ ×œ×©× ×•×ª ××•×ª×”)
                    const gridStart = customStrategyStart !== undefined ? customStrategyStart : spotEntry;
                    
                    // 4. ×—×™×©×•×‘ ×”××¨×—×§ ×”×›×•×œ×œ (×”×˜×•×•×— ×‘×™×Ÿ ×›× ×™×¡×” ×œ×¡×˜×•×¤) ×œ×˜×•×‘×ª ×”××“×¨×’×•×ª
                    const totalDistance = spotTP - gridStart;
                    
                    const setups: HedgeSetup[] = [];
                
                    // 5. ×œ×•×œ××ª ×—×™×©×•×‘ ×œ×›×œ ×’×™×“×•×¨
                    for (let i = 0; i < hedgesCount; i++) {
                        // ×—×™×©×•×‘ ×”××™×§×•× ×©×œ ×”×’×™×“×•×¨ ×¢×œ ×”×¡×§××œ×” ×”×œ×™× ××¨×™×ª
                        // ×¢×‘×•×¨ 4 ×’×™×“×•×¨×™×: 0%, 25%, 50%, 75%
                        const ratio = i / hedgesCount; 
                        
                        // ××—×™×¨ ×”×›× ×™×¡×” ×œ×’×™×“×•×¨ ×”× ×•×›×—×™
                        const entry = gridStart + (totalDistance * ratio);
                        
                        // ×”-SL ×ª××™×“ ×§×‘×•×¢ = Spot TP
                        const sl = spotTP;
                        
                        // ×”××¨×—×§ ×œ×¡×˜×•×¤ ××”×›× ×™×¡×” ×”× ×•×›×—×™×ª
                        const distanceToSL = Math.abs(sl - entry);
                        
                        // ×—×™×©×•×‘ ×›××•×ª ×”××˜×‘×¢×•×ª: Risk = Amount * Distance
                        const coinAmount = distanceToSL > 0 ? (riskPerHedge / distanceToSL) : 0;
                        
                        // ×—×™×©×•×‘ TP ×‘×™×—×¡ 1:1 ×œ×¡×™×›×•×Ÿ
                        // ×‘×’×™×“×•×¨ ×©×•×¨×˜, ×”-TP × ××•×š ×××—×™×¨ ×”×›× ×™×¡×”
                        const tp = entry - distanceToSL;
                
                        // ×—×™×©×•×‘ ×¨×•×•×— ×¤×•×˜× ×¦×™××œ×™ (××¨×—×§ ×œ-TP * ×›××•×ª)
                        const potentialProfit = Math.abs(entry - tp) * coinAmount;
                        
                        setups.push({
                            index: i + 1,
                            entry: parseFloat(entry.toFixed(4)),
                            tp: parseFloat(tp.toFixed(4)),
                            sl: parseFloat(sl.toFixed(4)),
                            riskAmount: parseFloat(riskPerHedge.toFixed(2)),
                            potentialProfit: parseFloat(potentialProfit.toFixed(2)),
                            coinAmount: parseFloat(coinAmount.toFixed(6)),
                            investAmount: parseFloat((entry * coinAmount).toFixed(2))
                        });
                    }
                
                    return setups;
                }

    Folder: components
        File: AuthModal.tsx
            Code:
            import React, { useState } from 'react';
            import { supabase } from '../lib/supabaseClient';
            
            interface AuthModalProps {
                isOpen: boolean;
                onClose: () => void;
            }
            
            export default function AuthModal({ isOpen, onClose }: AuthModalProps) {
                const [isLogin, setIsLogin] = useState(true);
                const [email, setEmail] = useState('');
                const [password, setPassword] = useState('');
                const [loading, setLoading] = useState(false);
                const [message, setMessage] = useState<{ text: string, type: 'success' | 'error' } | null>(null);
            
                if (!isOpen) return null;
            
                const handleAuth = async (e: React.FormEvent) => {
                    e.preventDefault();
                    setLoading(true);
                    setMessage(null);
            
                    try {
                        if (isLogin) {
                            const { error } = await supabase.auth.signInWithPassword({
                                email,
                                password,
                            });
                            if (error) throw error;
                            onClose(); // Close modal on success
                        } else {
                            const { error } = await supabase.auth.signUp({
                                email,
                                password,
                                options: {
                                    emailRedirectTo: `${window.location.origin}/`, // Redirect back to home after confirm
                                },
                            });
                            if (error) throw error;
                            setMessage({ text: '× ×©×œ×— ××™×™×œ ××™××•×ª! × × ×œ×‘×“×•×§ ××ª ×ª×™×‘×ª ×”×“×•××¨.', type: 'success' });
                        }
                    } catch (error: any) {
                        setMessage({ text: error.message || '×©×’×™××” ×‘××™××•×ª', type: 'error' });
                    } finally {
                        setLoading(false);
                    }
                };
            
                return (
                    <>
                        <div className="modal-overlay" onClick={onClose}></div>
                        <div className="glass-panel modal-content" style={{ textAlign: 'center' }}>
                            <h2 style={{ marginBottom: 20, fontWeight: 800 }}>
                                {isLogin ? '×”×ª×—×‘×¨×•×ª ×œ××¢×¨×›×ª' : '×”×¨×©××” ×œ××¢×¨×›×ª'}
                            </h2>
            
                            {message && (
                                <div style={{
                                    padding: 10,
                                    borderRadius: 8,
                                    marginBottom: 15,
                                    fontSize: '0.9rem',
                                    background: message.type === 'success' ? 'rgba(0, 184, 148, 0.2)' : 'rgba(255, 118, 117, 0.2)',
                                    color: message.type === 'success' ? '#00b894' : '#ff7675',
                                    border: `1px solid ${message.type === 'success' ? '#00b894' : '#ff7675'}`
                                }}>
                                    {message.text}
                                </div>
                            )}
            
                            <form onSubmit={handleAuth} style={{ display: 'flex', flexDirection: 'column', gap: 15 }}>
                                <div className="input-group">
                                    <label>××™××™×™×œ</label>
                                    <input
                                        type="email"
                                        required
                                        className="glass-input"
                                        value={email}
                                        onChange={(e) => setEmail(e.target.value)}
                                        placeholder="name@example.com"
                                    />
                                </div>
                                <div className="input-group">
                                    <label>×¡×™×¡××”</label>
                                    <input
                                        type="password"
                                        required
                                        className="glass-input"
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        placeholder="******"
                                        minLength={6}
                                    />
                                </div>
            
                                <button
                                    type="submit"
                                    disabled={loading}
                                    className="btn-action"
                                    style={{ background: isLogin ? '#6c5ce7' : '#00b894', color: 'white', marginTop: 10 }}
                                >
                                    {loading ? '××¢×‘×“...' : (isLogin ? '×”×ª×—×‘×¨' : '×”×™×¨×©×')}
                                </button>
                            </form>
            
                            <div style={{ marginTop: 20, fontSize: '0.9rem', opacity: 0.8 }}>
                                {isLogin ? '××™×Ÿ ×œ×š ××©×ª××© ×¢×“×™×™×Ÿ? ' : '×™×© ×œ×š ×›×‘×¨ ××©×ª××©? '}
                                <button
                                    onClick={() => { setIsLogin(!isLogin); setMessage(null); }}
                                    style={{ background: 'none', border: 'none', color: '#74b9ff', cursor: 'pointer', fontWeight: 'bold', textDecoration: 'underline' }}
                                >
                                    {isLogin ? '×”×™×¨×©× ×›××Ÿ' : '×”×ª×—×‘×¨ ×›××Ÿ'}
                                </button>
                            </div>
                        </div>
                    </>
                );
            }
        File: KeyboardShortcuts.tsx
            Code:
            // tradewall\src\components\KeyboardShortcuts.tsx
            
            import React from 'react';
            
            export default function KeyboardShortcuts() {
                return (
                    <div className="tab-content active">
                         <div className="calc-header">
                            <h2>×§×™×¦×•×¨×™ ××§×œ×“×ª</h2>
                            <p>×™×™×¢×•×œ ×¢×‘×•×“×” ×‘×•×•×™× ×“×•×¡</p>
                        </div>
                        <div className="shortcuts-grid">
                            {[
                                { keys: ['Win','Ctrl','D'], desc: '×™×•×¦×¨ ×©×•×œ×—×Ÿ ×¢×‘×•×“×” ×•×™×¨×˜×•××œ×™ ×—×“×©' },
                                { keys: ['Win','Tab'], desc: '××‘×˜ ××©×™××•×ª / ×©×•×œ×—× ×•×ª ×¢×‘×•×“×”' },
                                { keys: ['Alt','Tab'], desc: '××¢×‘×¨ ××”×™×¨ ×‘×™×Ÿ ×—×œ×•× ×•×ª' },
                                { keys: ['Win','V'], desc: '×”×™×¡×˜×•×¨×™×™×ª ×œ×•×— (Clipboard)' },
                                { keys: ['Win','Arrows'], desc: '×”×¦××“×ª ×—×œ×•× ×•×ª ×œ×¦×“×“×™×' },
                                { keys: ['Ctrl','Shift','T'], desc: '×©×—×–×•×¨ ×œ×©×•× ×™×ª ×©× ×¡×’×¨×”' },
                                { keys: ['Win','Shift','S'], desc: '×¦×™×œ×•× ××¡×š (Snipping Tool)' },
                                { keys: ['Win','E'], desc: '×¤×ª×™×—×ª ×¡×™×™×¨ ×”×§×‘×¦×™×' },
                            ].map((s, i) => (
                                <div key={i} className="shortcut-card">
                                    <div className="key-combo">
                                        {s.keys.map((k, j) => <React.Fragment key={j}><span className="key">{k}</span>{j < s.keys.length-1 && '+'}</React.Fragment>)}
                                    </div>
                                    <div className="shortcut-desc">{s.desc}</div>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            }
        File: LiveTicker.tsx
            Code:
            // tradewall\src\components\LiveTicker.tsx
            
            import React, { useState, useEffect, useRef } from 'react';
            import { supabase } from '../lib/supabaseClient';
            
            // ×˜×™×¤×•×¡×™×
            type Prices = {
                [key: string]: number;
            };
            
            export interface TickerItem {
                symbol: string;
                type: 'crypto' | 'stock';
                name: string;
            }
            
            interface LiveTickerProps {
                prices: Prices;
                onCoinClick: (coin: string) => void;
                userId: string | null;
                refreshTrigger: number;
                tickers: TickerItem[]; // ××§×‘×œ ××ª ×¨×©×™××ª ×”×˜×™×§×¨×™× ××”××‘×
                onTickerUpdate?: () => void; // ×¤×•× ×§×¦×™×” ×œ×¨×™×¢× ×•×Ÿ ×”× ×ª×•× ×™× ×‘×“×£ ×”××‘
            }
            
            interface Alert {
                id: string;
                coin: string;
                target_price: number;
                condition: 'above' | 'below';
                note?: string;
                user_id?: string;
            }
            
            // ×§×‘×•×¢×™×
            const FINNHUB_API_KEY = process.env.NEXT_PUBLIC_FINNHUB_API_KEY || "";
            
            // ×¨×©×™××ª × ×›×¡×™× ×¤×•×¤×•×œ×¨×™×™× ×œ×—×™×¤×•×© ××”×™×¨
            const POPULAR_ASSETS = [
                // Crypto
                { symbol: 'BTC', name: 'Bitcoin', type: 'crypto' },
                { symbol: 'ETH', name: 'Ethereum', type: 'crypto' },
                { symbol: 'BNB', name: 'Binance Coin', type: 'crypto' },
                { symbol: 'SOL', name: 'Solana', type: 'crypto' },
                { symbol: 'XRP', name: 'Ripple', type: 'crypto' },
                { symbol: 'ADA', name: 'Cardano', type: 'crypto' },
                { symbol: 'DOGE', name: 'Dogecoin', type: 'crypto' },
                { symbol: 'LINK', name: 'Chainlink', type: 'crypto' },
                { symbol: 'LTC', name: 'Litecoin', type: 'crypto' },
                { symbol: 'LUNC', name: 'Terra Classic', type: 'crypto' },
                // Stocks
                { symbol: 'AAPL', name: 'Apple Inc.', type: 'stock' },
                { symbol: 'TSLA', name: 'Tesla Inc.', type: 'stock' },
                { symbol: 'NVDA', name: 'NVIDIA Corp.', type: 'stock' },
                { symbol: 'MSFT', name: 'Microsoft', type: 'stock' },
                { symbol: 'GOOGL', name: 'Alphabet Inc.', type: 'stock' },
                { symbol: 'AMZN', name: 'Amazon.com', type: 'stock' },
                { symbol: 'META', name: 'Meta Platforms', type: 'stock' },
                { symbol: 'NFLX', name: 'Netflix', type: 'stock' },
                { symbol: 'AMD', name: 'Advanced Micro Devices', type: 'stock' },
                { symbol: 'COIN', name: 'Coinbase Global', type: 'stock' },
            ];
            
            // ×¦×‘×¢×™×
            const COIN_COLORS: { [key: string]: string } = {
                BTC: '#F7931A', ETH: '#627EEA', BNB: '#F3BA2F', SOL: '#14F195',
                AAPL: '#A2AAAD', TSLA: '#CC0000', NVDA: '#76B900' // ×¦×‘×¢×™ ×× ×™×•×ª ×œ×“×•×’××”
            };
            
            // --- ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×¤×•×¨××˜ ××—×™×¨ ×—×›× ---
            const formatPrice = (price: number) => {
                if (!price && price !== 0) return 'Loading...';
                if (price === 0) return '0.00';
                
                // ×œ××˜×‘×¢×•×ª "×–×•×œ×™×" ×××•×“ ×›××• LUNC (×œ××©×œ 0.000036)
                if (price < 0.0001) return price.toFixed(8);
                // ×œ××˜×‘×¢×•×ª ×–×•×œ×™× (××ª×—×ª ×œ×“×•×œ×¨)
                if (price < 1) return price.toFixed(6);
                // ×œ××˜×‘×¢×•×ª ×§×˜× ×™× (1-10 ×“×•×œ×¨)
                if (price < 10) return price.toFixed(4);
                
                // ×¨×’×™×œ (2 ×¡×¤×¨×•×ª ××—×¨×™ ×”× ×§×•×“×”)
                return price.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            };
            
            // --- ×¨×›×™×‘ ×‘×—×™×¨×” ××•×ª×× ××™×©×™×ª ---
            interface CustomSelectProps {
                value: string;
                options: { value: string; label: string }[];
                onChange: (value: string) => void;
            }
            
            const CustomDropdown = ({ value, options, onChange }: CustomSelectProps) => {
                const [isOpen, setIsOpen] = useState(false);
                const containerRef = useRef<HTMLDivElement>(null);
            
                useEffect(() => {
                    const handleClickOutside = (event: MouseEvent) => {
                        if (containerRef.current && !containerRef.current.contains(event.target as Node)) {
                            setIsOpen(false);
                        }
                    };
                    document.addEventListener('mousedown', handleClickOutside);
                    return () => document.removeEventListener('mousedown', handleClickOutside);
                }, []);
            
                const selectedLabel = options.find(o => o.value === value)?.label || value;
            
                return (
                    <div ref={containerRef} style={{ position: 'relative', flex: 1 }}>
                        <div 
                            className="glass-input"
                            onClick={() => setIsOpen(!isOpen)}
                            style={{
                                padding: '10px', cursor: 'pointer', display: 'flex',
                                justifyContent: 'space-between', alignItems: 'center',
                                fontSize: '0.9rem', userSelect: 'none'
                            }}
                        >
                            <span>{selectedLabel}</span>
                            <span style={{ fontSize: '0.7rem', opacity: 0.7, transform: isOpen ? 'rotate(180deg)' : 'rotate(0)', transition: '0.2s' }}>â–¼</span>
                        </div>
                        {isOpen && (
                            <div style={{
                                position: 'absolute', top: 'calc(100% + 4px)', left: 0, width: '100%',
                                background: '#1a1a2e', border: '1px solid rgba(255,255,255,0.1)',
                                borderRadius: '12px', zIndex: 1000, boxShadow: '0 4px 15px rgba(0,0,0,0.5)',
                                maxHeight: '200px', overflowY: 'auto'
                            }}>
                                {options.map((option) => (
                                    <div
                                        key={option.value}
                                        onClick={() => { onChange(option.value); setIsOpen(false); }}
                                        style={{
                                            padding: '10px 12px', cursor: 'pointer', fontSize: '0.9rem',
                                            borderBottom: '1px solid rgba(255,255,255,0.05)',
                                            background: value === option.value ? 'rgba(255,255,255,0.1)' : 'transparent',
                                            color: 'white'
                                        }}
                                        onMouseEnter={(e) => (e.currentTarget.style.background = 'rgba(255,255,255,0.15)')}
                                        onMouseLeave={(e) => (e.currentTarget.style.background = value === option.value ? 'rgba(255,255,255,0.1)' : 'transparent')}
                                    >
                                        {option.label}
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };
            
            // --- ×¨×›×™×‘ ×¡×˜×˜×•×¡ ×©×•×§ ---
            const MarketStatus = () => {
                const [isOpen, setIsOpen] = useState(false);
                
                useEffect(() => {
                    const checkMarket = () => {
                        const now = new Date();
                        const nyTime = new Date(now.toLocaleString("en-US", { timeZone: "America/New_York" }));
                        const day = nyTime.getDay(); 
                        const hour = nyTime.getHours();
                        const minute = nyTime.getMinutes();
                        const timeInMinutes = hour * 60 + minute;
            
                        const marketOpen = 9 * 60 + 30;
                        const marketClose = 16 * 60;
                        const isWeekday = day >= 1 && day <= 5;
            
                        const isOpenNow = isWeekday && timeInMinutes >= marketOpen && timeInMinutes < marketClose;
                        setIsOpen(isOpenNow);
                    };
            
                    checkMarket();
                    const interval = setInterval(checkMarket, 60000);
                    return () => clearInterval(interval);
                }, []);
            
                return (
                    <div style={{
                        fontSize: '0.8rem', padding: '8px', background: 'rgba(0,0,0,0.2)',
                        borderRadius: '8px', marginBottom: '10px', textAlign: 'center',
                        border: `1px solid ${isOpen ? 'rgba(0,255,136,0.3)' : 'rgba(255,77,77,0.3)'}`
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span>×©×•×§ ×”×× ×™×•×ª (NY):</span>
                            <span style={{ fontWeight: 'bold', color: isOpen ? '#00ff88' : '#ff4d4d' }}>
                                {isOpen ? '×¤×ª×•×— ğŸŸ¢' : '×¡×’×•×¨ ğŸ”´'}
                            </span>
                        </div>
                        <div style={{ fontSize: '0.7rem', opacity: 0.6, marginTop: 4 }}>
                            ×©×¢×•×ª ××¡×—×¨: 16:30 - 23:00 (×©×¢×•×Ÿ ×™×©×¨××œ)
                        </div>
                    </div>
                );
            };
            
            export default function LiveTicker({ prices, onCoinClick, userId, refreshTrigger, tickers, onTickerUpdate }: LiveTickerProps) {
                const [activeTab, setActiveTab] = useState<'market' | 'alerts'>('market');
                
                // × ×™×”×•×œ ×”×ª×¨××•×ª
                const [alerts, setAlerts] = useState<Alert[]>([]);
                
                // ×˜×•×¤×¡ ×”×•×¡×¤×ª ×”×ª×¨××”
                const [newAlertCoin, setNewAlertCoin] = useState('');
                const [newAlertPrice, setNewAlertPrice] = useState('');
                const [newAlertCondition, setNewAlertCondition] = useState<'above' | 'below'>('above');
                const [newAlertNote, setNewAlertNote] = useState(''); 
            
                // × ×™×”×•×œ ×—×™×¤×•×© ×•×”×•×¡×¤×ª ×˜×™×§×¨×™×
                const [isSearchOpen, setIsSearchOpen] = useState(false);
                const [searchType, setSearchType] = useState<'crypto' | 'stock'>('crypto');
                const [searchQuery, setSearchQuery] = useState('');
                const [isAdding, setIsAdding] = useState(false);
            
                // ×”×’×“×¨×ª ×‘×¨×™×¨×ª ××—×“×œ ×œ×§×•×™×Ÿ
                useEffect(() => {
                    if (tickers && tickers.length > 0 && !newAlertCoin) {
                        setNewAlertCoin(tickers[0].symbol);
                    }
                }, [tickers, newAlertCoin]);
            
                // ×—×œ×•×§×” ×œ×§×˜×’×•×¨×™×•×ª
                const cryptoList = tickers ? tickers.filter(t => t.type === 'crypto') : [];
                const stockList = tickers ? tickers.filter(t => t.type === 'stock') : [];
            
                // ×˜×¢×™× ×ª ×”×ª×¨××•×ª ××”-DB
                useEffect(() => {
                    if (userId) {
                        fetchAlerts();
                    } else {
                        setAlerts([]);
                    }
                }, [userId, refreshTrigger]);
            
                const fetchAlerts = async () => {
                    let query = supabase
                        .from('alerts')
                        .select('*')
                        .order('created_at', { ascending: false });
            
                    if (userId) {
                        query = query.eq('user_id', userId);
                    } else {
                        query = query.is('user_id', null);
                    }
            
                    const { data, error } = await query;
                    if (!error && data) setAlerts(data as Alert[]);
                };
            
                // ×‘×“×™×§×ª ×”×ª×¨××•×ª
                useEffect(() => {
                    if (alerts.length === 0) return;
                    const triggeredAlertIds: string[] = [];
            
                    alerts.forEach(alert => {
                        const currentPrice = prices[alert.coin];
                        if (!currentPrice) return;
            
                        let triggered = false;
                        if (alert.condition === 'above' && currentPrice >= alert.target_price) triggered = true;
                        else if (alert.condition === 'below' && currentPrice <= alert.target_price) triggered = true;
            
                        if (triggered) {
                            sendNotification(alert, currentPrice);
                            triggeredAlertIds.push(alert.id);
                        }
                    });
            
                    if (triggeredAlertIds.length > 0) removeTriggeredAlerts(triggeredAlertIds);
                }, [prices, alerts]);
            
                const removeTriggeredAlerts = async (ids: string[]) => {
                    setAlerts(prev => prev.filter(a => !ids.includes(a.id)));
                    await supabase.from('alerts').delete().in('id', ids);
                };
            
                const sendNotification = async (alert: Alert, currentPrice: number) => {
                    const direction = alert.condition === 'above' ? '×¢×œ×” ××¢×œ' : '×™×¨×“ ××ª×—×ª ×œ';
                    let message = `${alert.coin} ×”×’×™×¢ ×œ××—×™×¨ $${currentPrice}! (×™×¢×“: ${direction} $${alert.target_price})`;
                    if (alert.note) message += `\n×”×¢×¨×”: ${alert.note}`;
                    
                    try {
                        await fetch('/api/pushover', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ title: 'TradeWall Alert ğŸš€', message })
                        });
                    } catch (err) { console.error('Notification failed', err); }
                };
            
                // --- ×œ×•×’×™×§×ª ×”×•×¡×¤×”/××—×™×§×” ×©×œ ×˜×™×§×¨×™× ---
            
                const fetchStockName = async (symbol: string): Promise<string> => {
                    if (!FINNHUB_API_KEY) return symbol;
                    try {
                        // ×—×™×¤×•×© ×”×¡×™××•×œ ×‘-Finnhub ×›×“×™ ×œ×§×‘×œ ××ª ×”×©× ×”××œ× (Description)
                        const res = await fetch(`https://finnhub.io/api/v1/search?q=${symbol}&token=${FINNHUB_API_KEY}`);
                        if (!res.ok) return symbol;
                        
                        const data = await res.json();
                        // ××¦×™××ª ×”×ª×××” ××“×•×™×§×ª ×œ×¡×™××•×œ
                        if (data.result && data.result.length > 0) {
                            const match = data.result.find((r: any) => r.symbol === symbol) || data.result[0];
                            return match.description || match.symbol || symbol;
                        }
                        return symbol;
                    } catch (e) {
                        console.error("Failed to fetch stock name:", e);
                        return symbol;
                    }
                };
            
                const handleAddTicker = async (item: { symbol: string, name: string }) => {
                    if (!userId) return alert('× × ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×¢×¨×•×š ××ª ×”×¨×©×™××”');
                    
                    setIsAdding(true);
                    const symbol = item.symbol.toUpperCase();
                    let nameToSave = item.name;
            
                    // ×× ×–×• ×”×•×¡×¤×” ×™×“× ×™×ª (×”×©× ×–×”×” ×œ×¡×™××•×œ) ×•×–×• ×× ×™×”, × × ×¡×” ×œ××©×•×š ×©× ××œ×
                    if (searchType === 'stock' && nameToSave === symbol) {
                        nameToSave = await fetchStockName(symbol);
                    }
                    
                    const { error } = await supabase.from('tickers').insert([{
                        user_id: userId,
                        symbol: symbol,
                        type: searchType,
                        name: nameToSave
                    }]);
            
                    setIsAdding(false);
            
                    if (error) {
                        if (error.code === '23505') alert('××˜×‘×¢/×× ×™×” ×–×• ×›×‘×¨ ×§×™×™××ª ×‘×¨×©×™××” ×©×œ×š');
                        else alert('×©×’×™××” ×‘×”×•×¡×¤×”: ' + error.message);
                    } else {
                        setIsSearchOpen(false);
                        setSearchQuery('');
                        // ×¢×“×›×•×Ÿ ××™×™×“×™ ×©×œ ×“×£ ×”××‘
                        if (onTickerUpdate) onTickerUpdate(); 
                    }
                };
            
                const handleRemoveTicker = async (e: React.MouseEvent, symbol: string) => {
                    e.stopPropagation(); // ×œ×× ×•×¢ ×œ×—×™×¦×” ×¢×œ ×”×›×¨×˜×™×¡ ×©×‘×•×—×¨×ª ××•×ª×•
                    if (!userId) return;
                    if (!confirm(`×”×× ×œ×”×¡×™×¨ ××ª ${symbol} ××”×¨×©×™××”?`)) return;
            
                    const { error } = await supabase.from('tickers').delete().eq('user_id', userId).eq('symbol', symbol);
                    
                    if (error) {
                        alert('×©×’×™××” ×‘××—×™×§×”: ' + error.message);
                    } else {
                        // ×¢×“×›×•×Ÿ ××™×™×“×™ ×©×œ ×“×£ ×”××‘
                        if (onTickerUpdate) onTickerUpdate();
                    }
                };
            
                const addAlert = async () => {
                    if (!userId) return alert("×¢×œ×™×š ×œ×”×ª×—×‘×¨ ×›×“×™ ×œ×”×•×¡×™×£ ×”×ª×¨××•×ª");
                    if (!newAlertPrice) return;
                    const price = parseFloat(newAlertPrice);
                    if (isNaN(price)) return;
            
                    const { data, error } = await supabase.from('alerts').insert([{
                        coin: newAlertCoin, target_price: price, condition: newAlertCondition, note: newAlertNote, user_id: userId
                    }]).select();
            
                    if (error) alert('×©×’×™××”: ' + error.message);
                    else if (data) {
                        setAlerts(prev => [data[0] as Alert, ...prev]);
                        setNewAlertPrice(''); setNewAlertNote('');
                    }
                };
            
                const removeAlert = async (id: string) => {
                    setAlerts(prev => prev.filter(a => a.id !== id));
                    await supabase.from('alerts').delete().eq('id', id);
                };
            
                // ×¡×™× ×•×Ÿ ×ª×•×¦××•×ª ×—×™×¤×•×©
                const filteredAssets = POPULAR_ASSETS
                    .filter(a => a.type === searchType)
                    .filter(a => 
                        a.symbol.toLowerCase().includes(searchQuery.toLowerCase()) || 
                        a.name.toLowerCase().includes(searchQuery.toLowerCase())
                    );
            
                // ×¨×›×™×‘ ×¢×–×¨ ×œ×”×¦×’×ª ×¨×©×™××” (××¢×•×“×›×Ÿ ×¢× ×›×¤×ª×•×¨ ××—×™×§×”)
                const renderList = (items: TickerItem[]) => (
                    <div style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
                        {items.map(item => (
                            <div key={item.symbol} className="coin-card" onClick={() => onCoinClick(item.symbol)} style={{ cursor: 'pointer', position: 'relative' }}>
                                <div className="coin-info">
                                    <h3>{item.symbol}</h3>
                                    <span>{item.name}</span>
                                </div>
                                <div className="coin-price">
                                    <div className="price-val" style={{ color: (prices[item.symbol] || 0) > 0 ? '#00ff88' : 'white' }}>
                                        {prices[item.symbol] ? `$${formatPrice(prices[item.symbol])}` : 'Loading...'}
                                    </div>
                                </div>
                                
                                {/* ×›×¤×ª×•×¨ ××—×™×§×” */}
                                <button 
                                    onClick={(e) => handleRemoveTicker(e, item.symbol)}
                                    className="delete-ticker-btn"
                                    style={{
                                        position: 'absolute', top: 5, left: 5, 
                                        background: 'transparent', border: 'none', 
                                        color: '#ff7675', opacity: 0.5, cursor: 'pointer', fontSize: '1.1rem'
                                    }}
                                    title="×”×¡×¨ ××”×¨×©×™××”"
                                >
                                    ğŸ—‘
                                </button>
                            </div>
                        ))}
                    </div>
                );
            
                return (
                    <div className="glass-panel ticker-col" style={{ display: 'flex', flexDirection: 'column', height: '100%', padding: '16px', position: 'relative' }}>
                        {/* ×›×•×ª×¨×ª ×•×˜××‘×™× */}
                        <div style={{ display: 'flex', justifyContent: 'center', gap: 10, marginBottom: 15, borderBottom: '1px solid rgba(255,255,255,0.1)', paddingBottom: '10px' }}>
                            <button onClick={() => setActiveTab('market')} style={{ background: activeTab === 'market' ? 'rgba(255,255,255,0.2)' : 'transparent', border: 'none', color: 'white', padding: '6px 12px', borderRadius: 8, cursor: 'pointer', fontWeight: 'bold', fontSize: '0.9rem' }}>×©×•×§</button>
                            <button onClick={() => setActiveTab('alerts')} style={{ background: activeTab === 'alerts' ? 'rgba(255,255,255,0.2)' : 'transparent', border: 'none', color: 'white', padding: '6px 12px', borderRadius: 8, cursor: 'pointer', fontWeight: 'bold', fontSize: '0.9rem' }}>×”×ª×¨××•×ª ğŸ””</button>
                        </div>
            
                        <div style={{ flex: 1, overflowY: 'auto', paddingRight: '4px', paddingLeft: '4px' }}>
                            {activeTab === 'market' && (
                                <>
                                    {/* ×§×¨×™×¤×˜×• */}
                                    <div style={{ marginBottom: 20 }}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10, borderBottom: '2px solid #a29bfe', paddingBottom: 5 }}>
                                            <h4 style={{ color: '#a29bfe', margin: 0, fontSize: '0.9rem' }}>×§×¨×™×¤×˜×• (Crypto)</h4>
                                            <button 
                                                onClick={() => { setSearchType('crypto'); setIsSearchOpen(true); }}
                                                style={{ background: 'rgba(162, 155, 254, 0.2)', color: '#a29bfe', border: 'none', borderRadius: '50%', width: 24, height: 24, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                                            >+</button>
                                        </div>
                                        {renderList(cryptoList)}
                                    </div>
            
                                    {/* ×× ×™×•×ª */}
                                    <div>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 10, borderBottom: '2px solid #ff7675', paddingBottom: 5 }}>
                                            <h4 style={{ color: '#ff7675', margin: 0, fontSize: '0.9rem' }}>×× ×™×•×ª (Stocks)</h4>
                                            <button 
                                                onClick={() => { setSearchType('stock'); setIsSearchOpen(true); }}
                                                style={{ background: 'rgba(255, 118, 117, 0.2)', color: '#ff7675', border: 'none', borderRadius: '50%', width: 24, height: 24, cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center' }}
                                            >+</button>
                                        </div>
                                        <MarketStatus />
                                        {renderList(stockList)}
                                    </div>
                                </>
                            )}
            
                            {/* ×˜××‘ ×”×ª×¨××•×ª - ×œ×œ× ×©×™× ×•×™ */}
                            {activeTab === 'alerts' && (
                                <div>
                                    <div style={{ background: 'rgba(255,255,255,0.05)', padding: 12, borderRadius: 12, marginBottom: 15, border: '1px solid rgba(255,255,255,0.1)' }}>
                                        <h4 style={{ marginBottom: 10, textAlign: 'center', fontSize: '0.95rem' }}>×”×•×¡×£ ×”×ª×¨××” ×œ× ×™×™×“</h4>
                                        <div style={{ display: 'flex', gap: 10, marginBottom: 8 }}>
                                            <CustomDropdown value={newAlertCoin} options={tickers.map(c => ({ value: c.symbol, label: c.symbol }))} onChange={setNewAlertCoin} />
                                            <CustomDropdown value={newAlertCondition} options={[{ value: 'above', label: '××¢×œ' }, { value: 'below', label: '××ª×—×ª' }]} onChange={(v) => setNewAlertCondition(v as any)} />
                                        </div>
                                        <input type="number" placeholder="××—×™×¨ ×™×¢×“ ($)" value={newAlertPrice} onChange={e => setNewAlertPrice(e.target.value)} className="glass-input" style={{ padding: 12, marginBottom: 8, fontSize: '0.9rem' }} />
                                        <input type="text" placeholder="×”×¢×¨×”" value={newAlertNote} onChange={e => setNewAlertNote(e.target.value)} className="glass-input" style={{ padding: 12, marginBottom: 10, fontSize: '0.9rem' }} />
                                        <button onClick={addAlert} className="btn-action" style={{ background: '#6c5ce7', marginTop: 0, padding: 8, fontSize: '0.9rem' }}>+ ×¦×•×¨ ×•×©××•×¨</button>
                                    </div>
                                    <h4 style={{ marginBottom: 10, opacity: 0.8, fontSize: '0.9rem' }}>×”×ª×¨××•×ª ×¤×¢×™×œ×•×ª ({alerts.length})</h4>
                                    <div style={{ display: 'flex', flexDirection: 'column', gap: 8 }}>
                                        {alerts.map(alert => (
                                            <div key={alert.id} style={{
                                                background: 'rgba(0,0,0,0.3)', padding: '10px 12px', borderRadius: 8,
                                                borderLeft: `4px solid ${COIN_COLORS[alert.coin] || '#888'}`,
                                                display: 'flex', flexDirection: 'column', gap: 4,
                                                borderTop: '1px solid rgba(255,255,255,0.05)', borderRight: '1px solid rgba(255,255,255,0.05)', borderBottom: '1px solid rgba(255,255,255,0.05)'
                                            }}>
                                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', width: '100%' }}>
                                                    <div style={{ fontSize: '0.85rem' }}>
                                                        <span style={{ fontWeight: 'bold' }}>{alert.coin}</span>
                                                        <span style={{ opacity: 0.9, color: alert.condition === 'above' ? '#00b894' : '#ff7675' }}>
                                                            {' '}{alert.condition === 'above' ? '××¢×œ' : '××ª×—×ª'} ${alert.target_price}
                                                        </span>
                                                    </div>
                                                    <button onClick={() => removeAlert(alert.id)} style={{ background: 'transparent', border: 'none', color: '#ff7675', cursor: 'pointer', fontSize: '1.2rem', padding: '0 5px' }}>Ã—</button>
                                                </div>
                                                {alert.note && <div style={{ fontSize: '0.75rem', opacity: 0.6, fontStyle: 'italic' }}>"{alert.note}"</div>}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                        </div>
            
                        {/* --- ××•×“××œ ×—×™×¤×•×© ×•×”×•×¡×¤×” --- */}
                        {isSearchOpen && (
                            <div style={{
                                position: 'absolute', top: 0, left: 0, width: '100%', height: '100%',
                                background: 'rgba(16, 18, 27, 0.95)', backdropFilter: 'blur(10px)',
                                zIndex: 2000, padding: 20, display: 'flex', flexDirection: 'column', borderRadius: 24
                            }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 15 }}>
                                    <h3 style={{ margin: 0 }}>×”×•×¡×£ {searchType === 'crypto' ? '×§×¨×™×¤×˜×•' : '×× ×™×”'}</h3>
                                    <button onClick={() => setIsSearchOpen(false)} style={{ background: 'none', border: 'none', color: 'white', fontSize: '1.5rem', cursor: 'pointer' }}>Ã—</button>
                                </div>
                                
                                <input 
                                    type="text" 
                                    placeholder="×—×¤×© ×¡×™××•×œ (×œ××©×œ: BTC, AAPL)..." 
                                    value={searchQuery}
                                    onChange={e => setSearchQuery(e.target.value)}
                                    className="glass-input"
                                    autoFocus
                                    style={{ padding: 12, marginBottom: 15 }}
                                />
            
                                <div style={{ flex: 1, overflowY: 'auto', display: 'flex', flexDirection: 'column', gap: 8 }}>
                                    {/* ×”×¦×’×ª ×ª×•×¦××•×ª ××”×¨×©×™××” ×”×¤×•×¤×•×œ×¨×™×ª */}
                                    {filteredAssets.map(asset => (
                                        <div 
                                            key={asset.symbol} 
                                            onClick={() => handleAddTicker(asset)}
                                            style={{
                                                padding: '12px', background: 'rgba(255,255,255,0.05)', 
                                                borderRadius: 12, cursor: 'pointer', display: 'flex', justifyContent: 'space-between',
                                                border: '1px solid rgba(255,255,255,0.05)'
                                            }}
                                        >
                                            <span style={{ fontWeight: 'bold' }}>{asset.symbol}</span>
                                            <span style={{ opacity: 0.7, fontSize: '0.9rem' }}>{asset.name}</span>
                                        </div>
                                    ))}
            
                                    {/* ××•×¤×¦×™×” ×œ×”×•×¡×¤×” ×™×“× ×™×ª ×× ×œ× × ××¦× ×‘×¨×©×™××” ×”×¤×•×¤×•×œ×¨×™×ª */}
                                    {searchQuery.length > 0 && !filteredAssets.find(a => a.symbol === searchQuery.toUpperCase()) && (
                                        <div 
                                            onClick={() => handleAddTicker({ symbol: searchQuery.toUpperCase(), name: searchQuery.toUpperCase() })}
                                            style={{
                                                padding: '12px', background: 'rgba(108, 92, 231, 0.2)', 
                                                borderRadius: 12, cursor: 'pointer', textAlign: 'center',
                                                border: '1px solid #6c5ce7', marginTop: 10
                                            }}
                                        >
                                            {isAdding 
                                                ? <span>××—×¤×© ×©× ×•××•×¡×™×£...</span>
                                                : <span>+ ×”×•×¡×£ <strong>{searchQuery.toUpperCase()}</strong> ×›-{searchType === 'crypto' ? '×§×¨×™×¤×˜×•' : '×× ×™×”'}</span>
                                            }
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
        File: PositionModal.tsx
            Code:
            import React, { useState, useEffect } from 'react';
            import { supabase } from '../lib/supabaseClient';
            import { calculateHedgeStrategy, HedgeSetup } from '../app/utils/hedgeLogic';
            
            // --- Types (Shared) ---
            // ×©×›×¤×•×œ ×”-Interface ×›×“×™ ×œ× ×œ×™×¦×•×¨ ×ª×œ×•×ª ×‘×§×•×‘×¥ ×—×™×¦×•× ×™ ×× ×œ× ×§×™×™×, 
            // ×‘××™×“×” ×•×™×© ×§×•×‘×¥ types.ts ×¢×“×™×£ ×œ×™×™×‘× ××©×.
            export interface Position {
                id: string;
                entry: number;
                amount: number;
                tp: number;
                sl: number;
                risk: number;
                currency: string;
                trade_date?: string;
                trade_time?: string;
                shorts: Position[];
                user_id?: string;
                strategy_hedges_count?: number;
                strategy_risk_percent?: number;
                symbol: string; // Added symbol to interface for easier access
                parent_id?: string | null;
            }
            
            interface PositionModalProps {
                isOpen: boolean;
                onClose: () => void;
                mode: 'add' | 'edit';
                coin: string;
                currentPrice: number;
                user: any;
                
                // ×× ×× ×—× ×• ×¢×•×¨×›×™× ××• ××•×¡×™×¤×™× ×’×™×“×•×¨ ×œ×¡×¤×•×˜ ×§×™×™× - × ×¢×‘×™×¨ ××•×ª×• ×›××Ÿ
                parentSpot: Position | null;
                
                // ×× ×× ×—× ×• ×¢×•×¨×›×™× ×’×™×“×•×¨ ×¡×¤×¦×™×¤×™ - × ×¢×‘×™×¨ ××ª ×”××•×‘×™×™×§×˜ ×©×œ×• (××• ×”××™× ×“×§×¡)
                // ×œ×¦×•×¨×š ×¤×©×˜×•×ª × ×¢×‘×™×¨ ××ª ×”××•×‘×™×™×§×˜ ×•×”××™× ×“×§×¡ ×œ×—×™×©×•×‘×™×
                childHedge: Position | null;
                childHedgeIndex: number | null; // 0 for Hedge 1, 1 for Hedge 2...
            
                onSuccess: (refreshAlerts: boolean) => void;
            }
            
            export default function PositionModal({
                isOpen,
                onClose,
                mode,
                coin,
                currentPrice,
                user,
                parentSpot,
                childHedge,
                childHedgeIndex,
                onSuccess
            }: PositionModalProps) {
                
                // --- Initial State Helpers ---
                const getInitialDate = () => new Date().toISOString().split('T')[0];
                const getInitialTime = () => new Date().toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
            
                // --- State ---
                const [data, setData] = useState({
                    entry: '',
                    amount: '',
                    tp: '',
                    sl: '',
                    risk: '',
                    currency: 'USDT',
                    date: getInitialDate(),
                    time: getInitialTime()
                });
            
                const [strategy, setStrategy] = useState({
                    isActive: false,
                    hedgesCount: 2,
                    riskPercent: 0,
                    currentHedgeIndex: 1,
                    calculatedSetups: [] as HedgeSetup[]
                });
            
                const [createAlerts, setCreateAlerts] = useState(false);
            
                // --- Effects ---
                
                // ××ª×—×•×œ ×”×˜×•×¤×¡ ×‘×¤×ª×™×—×”
                useEffect(() => {
                    if (isOpen) {
                        initializeForm();
                    }
                }, [isOpen, coin, mode, parentSpot, childHedge]);
            
                const initializeForm = () => {
                    // ××™×¤×•×¡ ×‘×¡×™×¡×™
                    let initialData = {
                        entry: currentPrice ? currentPrice.toString() : '',
                        amount: '',
                        tp: '',
                        sl: '',
                        risk: '',
                        currency: 'USDT',
                        date: getInitialDate(),
                        time: getInitialTime()
                    };
            
                    let strategyState = {
                        isActive: false,
                        hedgesCount: 2,
                        riskPercent: 0,
                        currentHedgeIndex: 1,
                        calculatedSetups: [] as HedgeSetup[]
                    };
            
                    setCreateAlerts(false);
            
                    // ××¦×‘ ×”×•×¡×¤×”
                    if (mode === 'add') {
                        if (parentSpot) {
                            // ×”×•×¡×¤×ª ×’×™×“×•×¨ (Hedge)
                            // ×× ×œ×¡×¤×•×˜ ×™×© TP, ×”×•× ×”×•×¤×š ×œ-SL ×©×œ ×”×’×™×“×•×¨ (×œ×•×’×™×§×” × ×¤×•×¦×” ×‘×’×™×“×•×¨×™×)
                            if (parentSpot.tp) {
                                initialData.sl = parentSpot.tp.toString();
                            }
            
                            // ×—×™×©×•×‘ ××¡×¤×¨ ×”×’×™×“×•×¨ ×”×‘×
                            const nextHedgeNum = (parentSpot.shorts?.length || 0) + 1;
                            strategyState.currentHedgeIndex = nextHedgeNum;
            
                            // ×‘×“×™×§×” ×× ×§×™×™××ª ××¡×˜×¨×˜×’×™×” ××•×’×“×¨×ª ××¨××© ×‘×¡×¤×•×˜
                            if (parentSpot.strategy_risk_percent && parentSpot.strategy_hedges_count) {
                                const setups = calculateHedgeStrategy(
                                    parentSpot.entry,
                                    parentSpot.tp,
                                    parentSpot.amount,
                                    parentSpot.strategy_risk_percent,
                                    parentSpot.strategy_hedges_count
                                );
                                
                                const setupToApply = setups[parentSpot.shorts?.length || 0];
                                
                                if (setupToApply) {
                                    initialData.entry = setupToApply.entry.toString();
                                    initialData.tp = setupToApply.tp.toString();
                                    initialData.sl = setupToApply.sl.toString();
                                    initialData.amount = setupToApply.coinAmount.toString();
                                    initialData.risk = setupToApply.riskAmount.toString();
                                    
                                    strategyState.isActive = true;
                                    strategyState.hedgesCount = parentSpot.strategy_hedges_count;
                                    strategyState.riskPercent = parentSpot.strategy_risk_percent;
                                    strategyState.calculatedSetups = setups;
                                }
                            }
                        } else {
                            // ×”×•×¡×¤×ª ×¡×¤×•×˜ ×—×“×© - ×”××—×™×¨ ×”× ×•×›×—×™ ×›×‘×¨ ×”×•×–×Ÿ ×‘-initialData
                        }
                    } 
                    // ××¦×‘ ×¢×¨×™×›×”
                    else if (mode === 'edit') {
                        const source = childHedge || parentSpot;
                        if (source) {
                            initialData = {
                                ...initialData,
                                entry: source.entry.toString(),
                                amount: source.amount.toString(),
                                tp: source.tp.toString(),
                                sl: source.sl.toString(),
                                risk: source.risk.toString(),
                                currency: source.currency,
                                date: source.trade_date || getInitialDate(),
                                time: source.trade_time || getInitialTime()
                            };
                        }
                    }
            
                    setData(initialData);
                    setStrategy(strategyState);
                };
            
                // --- Logic ---
            
                const calculateValues = () => {
                    const entry = parseFloat(data.entry);
                    const amount = parseFloat(data.amount);
                    const tp = parseFloat(data.tp);
                    const sl = parseFloat(data.sl);
            
                    let calcInvest = 0;
                    let calcProfit = 0;
                    let calcRisk = 0;
            
                    // ×”×× ×–×” ×¡×¤×•×˜? (×”×•×¡×¤×ª ×¡×¤×•×˜, ××• ×¢×¨×™×›×ª ×¡×¤×•×˜)
                    const isSpot = (mode === 'add' && !parentSpot) || (mode === 'edit' && !childHedge);
            
                    if (entry && !isNaN(entry) && amount && !isNaN(amount)) {
                        calcInvest = amount * entry;
            
                        // ×¨×•×•×— ×¤×•×˜× ×¦×™××œ×™ (TP)
                        if (tp && !isNaN(tp)) {
                            if (isSpot) calcProfit = (tp - entry) * amount;
                            else calcProfit = Math.abs(entry - tp) * amount; // ×©×•×¨×˜
                        }
            
                        // ×¡×™×›×•×Ÿ ×¤×•×˜× ×¦×™××œ×™ (SL)
                        if (sl && !isNaN(sl)) {
                            if (isSpot) calcRisk = (entry - sl) * amount; // ×œ×•× ×’: ×”×¤×¡×“ ×›×©×”××—×™×¨ ×™×•×¨×“
                            else calcRisk = Math.abs(sl - entry) * amount; // ×©×•×¨×˜: ×”×¤×¡×“ ×›×©×”××—×™×¨ ×¢×•×œ×”
                        } else {
                            // ×× ××™×Ÿ ×¡×˜×•×¤, ×œ×•×§×—×™× ××ª ×”×¨×™×¡×§ ××”×©×“×” ×”×™×“× ×™
                            calcRisk = parseFloat(data.risk) || 0;
                        }
                    }
            
                    return { calcInvest, calcProfit, calcRisk };
                };
            
                const handleInput = (field: string, value: string) => {
                    const newData = { ...data, [field]: value };
                    
                    // --- 1. Hedge Strategy Logic (Priority) ---
                    // ×›××©×¨ ××¡×˜×¨×˜×’×™×” ×¤×¢×™×œ×” ×•×× ×• ××•×¡×™×¤×™× ×’×™×“×•×¨, ×©×™× ×•×™ ×™×“× ×™ ×©×œ ××—×™×¨ ×›× ×™×¡×” ××• ×¡×˜×•×¤
                    // ×¦×¨×™×š ×œ×©××•×¨ ×¢×œ ×¡×›×•× ×”×¡×™×›×•×Ÿ (Risk Amount) ×§×‘×•×¢ ×•×œ×¢×“×›×Ÿ ××ª ×”×›××•×ª ×•×”×™×¢×“ (TP) ×‘×”×ª××.
                    if (strategy.isActive && parentSpot && mode === 'add' && (field === 'entry' || field === 'sl')) {
                        const newEntry = field === 'entry' ? parseFloat(value) : parseFloat(newData.entry);
                        const newSL = field === 'sl' ? parseFloat(value) : parseFloat(newData.sl);
                        
                        // ×× ×—× ×• ××©×ª××©×™× ×‘×¢×¨×š ×”×¡×™×›×•×Ÿ ×”×§×™×™× ×›×¢×•×’×Ÿ
                        const targetRisk = parseFloat(data.risk);
            
                        if (!isNaN(newEntry) && !isNaN(newSL) && !isNaN(targetRisk) && newEntry !== newSL) {
                            const diff = Math.abs(newEntry - newSL);
                            
                            // ×—×™×©×•×‘ ×›××•×ª ×—×“×©×” ×›×“×™ ×œ×©××•×¨ ×¢×œ ×”×¡×™×›×•×Ÿ ×”×§×‘×•×¢
                            const newAmount = targetRisk / diff;
                            
                            // ×—×™×©×•×‘ TP ×—×“×© ×›×“×™ ×œ×©××•×¨ ×¢×œ ×™×—×¡ ×¡×™×›×•×Ÿ/×¡×™×›×•×™ ×©×œ 1:1
                            // ×”× ×•×¡×—×”: TP = 2 * Entry - SL
                            const newTP = (2 * newEntry) - newSL;
            
                            newData.amount = newAmount.toFixed(6);
                            newData.tp = newTP.toFixed(4);
                            
                            // ×œ× ××¢×“×›× ×™× ××ª ×”-Risk ×›×™ ×”××˜×¨×” ×”×™× ×©×”×•× ×™×™×©××¨ ×§×‘×•×¢
                        }
                        
                        setData(newData);
                        return; // ×¢×•×¦×¨×™× ×›××Ÿ ×›×“×™ ×œ×× ×•×¢ ×“×¨×™×¡×” ×¢"×™ ×”×œ×•×’×™×§×” ×”×¨×’×™×œ×” ×œ××˜×”
                    }
            
                    // --- 2. Standard Risk Calculation Logic ---
                    
                    // Case: User changes RISK -> Recalculate AMOUNT
                    if (field === 'risk') {
                         const riskVal = parseFloat(value);
                         const entryVal = parseFloat(newData.entry);
                         const slVal = parseFloat(newData.sl);
                         
                         if (!isNaN(riskVal) && !isNaN(entryVal) && !isNaN(slVal) && entryVal !== slVal) {
                             const diff = Math.abs(entryVal - slVal);
                             const newAmount = riskVal / diff;
                             newData.amount = newAmount.toFixed(6);
                         }
                    }
                    
                    // Case: User changes ENTRY, SL, or AMOUNT
                    else if (field === 'amount' || field === 'entry' || field === 'sl') {
                        const entryVal = parseFloat(newData.entry);
                        const slVal = parseFloat(newData.sl);
                        const amountVal = parseFloat(newData.amount);
                        const riskVal = parseFloat(data.risk);
            
                        // Sub-case A: Amount is empty/zero, but we have Risk -> Calculate Amount
                        // ×–×” ×”×ª×™×§×•×Ÿ ×œ×‘×¢×™×” ×©×œ ×”×¡×¤×•×˜: ×× ×™×© ×¨×™×¡×§ ××‘×œ ××™×Ÿ ×›××•×ª, × ×—×©×‘ ×›××•×ª
                        if (field !== 'amount' && (isNaN(amountVal) || amountVal === 0) && !isNaN(riskVal) && riskVal > 0 && !isNaN(entryVal) && !isNaN(slVal) && entryVal !== slVal) {
                             const diff = Math.abs(entryVal - slVal);
                             const newAmount = riskVal / diff;
                             newData.amount = newAmount.toFixed(6);
                        } 
                        // Sub-case B: Standard behavior - We have Amount (or user is typing Amount), calculate Risk
                        else if (!isNaN(amountVal) && !isNaN(entryVal) && !isNaN(slVal)) {
                             const diff = Math.abs(entryVal - slVal);
                             const newRisk = diff * amountVal;
                             newData.risk = newRisk.toFixed(2);
                        }
                    }
                    
                    setData(newData);
                };
            
                const applyHedgeStrategy = (percent: number) => {
                    if (!parentSpot) return;
                    
                    const currentFormEntry = parseFloat(data.entry);
                    // ×× ×”××©×ª××© ×”×–×™×Ÿ ××—×™×¨ ×›× ×™×¡×”, × ×©×ª××© ×‘×• ×›×‘×¡×™×¡, ××—×¨×ª × ×©×ª××© ×‘××—×™×¨ ×”×›× ×™×¡×” ×©×œ ×”×¡×¤×•×˜ (××• ××—×™×¨ × ×•×›×—×™)
                    const startPrice = !isNaN(currentFormEntry) ? currentFormEntry : parentSpot.entry;
                    
                    const currentFormSL = parseFloat(data.sl);
                    // ×× ×”××©×ª××© ×”×–×™×Ÿ ×¡×˜×•×¤, × ×©×ª××© ×‘×•, ××—×¨×ª × ×©×ª××© ×‘-TP ×©×œ ×”×¡×¤×•×˜ (×©×”×•× ×”×¡×˜×•×¤ ×©×œ ×”×’×™×“×•×¨ ×‘×“"×›)
                    const targetSL = !isNaN(currentFormSL) ? currentFormSL : parentSpot.tp;
            
                    const setups = calculateHedgeStrategy(
                        parentSpot.entry,
                        targetSL,
                        parentSpot.amount,
                        percent, 
                        strategy.hedgesCount,
                        startPrice
                    );
            
                    const nextHedgeIdx = strategy.currentHedgeIndex - 1; 
                    const setupToApply = setups[nextHedgeIdx];
            
                    if (setupToApply) {
                        setStrategy(prev => ({
                            ...prev,
                            isActive: true,
                            riskPercent: percent,
                            calculatedSetups: setups,
                        }));
                        
                        setData(prev => ({
                            ...prev,
                            entry: setupToApply.entry.toString(),
                            tp: setupToApply.tp.toString(),
                            sl: setupToApply.sl.toString(),
                            amount: setupToApply.coinAmount.toString(),
                            risk: setupToApply.riskAmount.toString(),
                        }));
                    }
                };
            
                const handleSave = async () => {
                    if (!user) {
                        alert("× × ×œ×”×ª×—×‘×¨");
                        return;
                    }
            
                    const entry = parseFloat(data.entry);
                    const amount = parseFloat(data.amount);
            
                    if (!entry || !amount) {
                        alert("× × ×œ××œ× ××—×™×¨ ×•×›××•×ª");
                        return;
                    }
            
                    const tpVal = parseFloat(data.tp) || 0;
                    const slVal = parseFloat(data.sl) || 0;
            
                    const dbPayload: any = {
                        symbol: coin,
                        entry: entry,
                        amount: amount,
                        tp: tpVal,
                        sl: slVal,
                        risk: parseFloat(data.risk) || 0,
                        currency: data.currency,
                        trade_date: data.date,
                        trade_time: data.time,
                        user_id: user.id
                    };
            
                    try {
                        let savedRecord: any = null;
                        let refreshAlerts = false;
            
                        if (mode === 'add') {
                            if (!parentSpot) {
                                // ×™×¦×™×¨×ª ×¡×¤×•×˜ ×—×“×©
                                dbPayload.parent_id = null;
                                const { data: inserted, error } = await supabase.from('positions').insert([dbPayload]).select();
                                if (error) throw error;
                                savedRecord = inserted[0];
                            } else {
                                // ×™×¦×™×¨×ª ×’×™×“×•×¨ (Hedge)
                                dbPayload.parent_id = parentSpot.id;
                                
                                // ×¢×“×›×•×Ÿ ××¡×˜×¨×˜×’×™×” ×‘×¡×¤×•×˜ ×”××‘ ×× ×–×• ×¤×¢× ×¨××©×•× ×” ××• ×©×”×©×ª× ×ª×”
                                if (strategy.isActive && (parentSpot.shorts?.length === 0 || strategy.currentHedgeIndex === 1)) {
                                    await supabase.from('positions').update({
                                        strategy_hedges_count: strategy.hedgesCount,
                                        strategy_risk_percent: strategy.riskPercent
                                    }).eq('id', parentSpot.id);
                                }
            
                                const { data: inserted, error } = await supabase.from('positions').insert([dbPayload]).select();
                                if (error) throw error;
                                savedRecord = inserted[0];
                            }
            
                        } else {
                            // ×¢×¨×™×›×”
                            let idToUpdate = '';
                            if (childHedge) {
                                idToUpdate = childHedge.id;
                            } else if (parentSpot) {
                                idToUpdate = parentSpot.id;
                            }
                            
                            if (idToUpdate) {
                                const { data: updated, error } = await supabase.from('positions').update(dbPayload).eq('id', idToUpdate).select();
                                if (error) throw error;
                                savedRecord = updated[0];
                            }
                        }
            
                        // ×™×¦×™×¨×ª ×”×ª×¨××•×ª ×× ×”××©×ª××© ×¡×™××Ÿ
                        if (createAlerts && savedRecord) {
                            const alertsToCreate = [];
            
                            if (!parentSpot) {
                                // ×”×ª×¨××•×ª ×œ×¡×¤×•×˜
                                if (tpVal > 0) alertsToCreate.push({ coin, target_price: tpVal, condition: 'above', note: `Spot ${coin} TP Hit - Close All`, user_id: user.id });
                                if (slVal > 0) alertsToCreate.push({ coin, target_price: slVal, condition: 'below', note: `Spot ${coin} SL Hit`, user_id: user.id });
                            } else {
                                // ×”×ª×¨××•×ª ×œ×’×™×“×•×¨
                                if (tpVal > 0) alertsToCreate.push({ 
                                    coin, target_price: tpVal, condition: 'below', 
                                    note: `Hedge ${strategy.currentHedgeIndex} (${coin}) TP`, user_id: user.id 
                                });
                                if (slVal > 0) alertsToCreate.push({ 
                                    coin, target_price: slVal, condition: 'above', 
                                    note: `Hedge ${strategy.currentHedgeIndex} (${coin}) SL`, user_id: user.id 
                                });
            
                                // ×”×ª×¨××” ×œ×›× ×™×¡×” ×œ×’×™×“×•×¨ ×”×‘× (×× ×—×•×©×‘ ×‘××¡×˜×¨×˜×’×™×”)
                                if (strategy.calculatedSetups && strategy.calculatedSetups.length > 0) {
                                    const nextSetup = strategy.calculatedSetups.find(s => s.index === strategy.currentHedgeIndex + 1);
                                    
                                    if (nextSetup) {
                                        alertsToCreate.push({
                                            coin: coin,
                                            target_price: nextSetup.entry,
                                            condition: 'above',
                                            note: `âš ï¸ ENTER HEDGE ${nextSetup.index} @ $${nextSetup.entry} | Amt: ${nextSetup.coinAmount} | Inv: $${nextSetup.investAmount} | TP: ${nextSetup.tp} | SL: ${nextSetup.sl}`,
                                            user_id: user.id
                                        });
                                    }
                                }
                            }
            
                            if (alertsToCreate.length > 0) {
                                await supabase.from('alerts').insert(alertsToCreate);
                                refreshAlerts = true;
                            }
                        }
            
                        onSuccess(refreshAlerts);
                        onClose();
            
                    } catch (err: any) {
                        console.error("Error saving position:", err.message);
                        alert("×©×’×™××” ×‘×©××™×¨×”: " + err.message);
                    }
                };
            
                const { calcInvest, calcProfit, calcRisk } = calculateValues();
            
                if (!isOpen) return null;
            
                return (
                    <>
                        <div className="modal-overlay" onClick={onClose}></div>
                        <div className="glass-panel modal-content" style={{width: 420}}>
                            <h3 style={{ textAlign: 'center', marginBottom: 20 }}>
                                {mode === 'add'
                                    ? (!parentSpot ? `×”×•×¡×¤×ª ×¡×¤×•×˜ ${coin}` : `×”×•×¡×¤×ª ×’×™×“×•×¨ (Hedge ${strategy.currentHedgeIndex})`)
                                    : '×¢×¨×™×›×ª ×¤×•×–×™×¦×™×”'
                                }
                            </h3>
            
                            {/* ×‘×—×™×¨×ª ××¡×˜×¨×˜×’×™×” - ××•×¦×’ ×¨×§ ×‘×”×•×¡×¤×ª ×’×™×“×•×¨ ×¨××©×•×Ÿ */}
                            {mode === 'add' && parentSpot && strategy.currentHedgeIndex === 1 && (
                                <div style={{marginBottom: 20, padding: 10, background: 'rgba(255,255,255,0.05)', borderRadius: 10}}>
                                    <div style={{fontSize:'0.85rem', marginBottom: 8, textAlign:'center'}}>×‘×—×¨ ××¡×˜×¨×˜×’×™×” (×ª×—×•×œ ×¢×œ ×›×œ ×”×’×™×“×•×¨×™×):</div>
                                    <div style={{display:'flex', justifyContent:'center', gap:5, marginBottom:10}}>
                                        {[2,3,4].map(num => (
                                            <button 
                                                key={num}
                                                onClick={() => setStrategy(prev => ({...prev, hedgesCount: num}))}
                                                style={{
                                                    background: strategy.hedgesCount === num ? '#00b894' : '#333',
                                                    border: 'none', borderRadius: 4, padding: '4px 10px', color: 'white', cursor:'pointer', fontSize: '0.8rem'
                                                }}
                                            >
                                                {num} ×’×™×“×•×¨×™×
                                            </button>
                                        ))}
                                    </div>
                                    <div style={{display:'flex', gap: 5, justifyContent: 'center'}}>
                                        {[25, 50, 75, 100].map(pct => (
                                            <button 
                                                key={pct}
                                                onClick={() => applyHedgeStrategy(pct)}
                                                className="btn-action"
                                                style={{
                                                    background: strategy.riskPercent === pct ? '#6c5ce7' : 'rgba(255,255,255,0.1)',
                                                    fontSize: '0.8rem', padding: '6px 12px', border: '1px solid rgba(255,255,255,0.1)', width: 'auto'
                                                }}
                                            >
                                                {pct}% ×¡×™×›×•×Ÿ
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}
            
                            <div style={{ display: 'flex', gap: 10 }}>
                                 <div className="input-group" style={{ flex: 1 }}>
                                    <label>×ª××¨×™×š</label>
                                    <input type="date" className="glass-input" value={data.date} onChange={e => handleInput('date', e.target.value)} />
                                 </div>
                                 <div className="input-group" style={{ flex: 1 }}>
                                    <label>×©×¢×”</label>
                                    <input type="time" className="glass-input" value={data.time} onChange={e => handleInput('time', e.target.value)} />
                                 </div>
                            </div>
            
                            <div className="input-group">
                                <label>××—×™×¨ ×›× ×™×¡×” ($)</label>
                                <input type="number" className="glass-input" value={data.entry} onChange={e => handleInput('entry', e.target.value)} />
                            </div>
            
                            <div style={{ display: 'flex', gap: 10 }}>
                                <div className="input-group" style={{ flex: 1 }}>
                                    <label>TP (×™×¢×“)</label>
                                    <input type="number" className="glass-input" value={data.tp} onChange={e => handleInput('tp', e.target.value)} />
                                </div>
                                <div className="input-group" style={{ flex: 1 }}>
                                    <label>SL (×¡×˜×•×¤)</label>
                                    <input type="number" className="glass-input" value={data.sl} onChange={e => handleInput('sl', e.target.value)} />
                                </div>
                            </div>
            
                            {/* ×ª×¦×•×’×ª ×¨×•×•×—/×”×¤×¡×“ ×¤×•×˜× ×¦×™××œ×™ */}
                            <div style={{
                                display:'flex', justifyContent:'space-around', alignItems:'center', 
                                marginBottom:12, padding:10, borderRadius:8, 
                                background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)'
                            }}>
                                <div style={{textAlign:'center'}}>
                                    <div style={{fontSize:'0.75rem', opacity:0.8, marginBottom:2}}>×”×¤×¡×“ ×¤×•×˜× ×¦×™××œ×™ (Risk)</div>
                                    <div style={{color:'#ff7675', fontWeight:'bold', fontFamily:'monospace', fontSize:'1rem'}}>
                                        -${calcRisk.toLocaleString(undefined, {maximumFractionDigits:2})}
                                    </div>
                                </div>
                                <div style={{width:1, height:30, background:'rgba(255,255,255,0.2)'}}></div>
                                <div style={{textAlign:'center'}}>
                                    <div style={{fontSize:'0.75rem', opacity:0.8, marginBottom:2}}>×¨×•×•×— ×¤×•×˜× ×¦×™××œ×™ (Reward)</div>
                                    <div style={{color:'#00b894', fontWeight:'bold', fontFamily:'monospace', fontSize:'1rem'}}>
                                        +${calcProfit.toLocaleString(undefined, {maximumFractionDigits:2})}
                                    </div>
                                </div>
                            </div>
            
                            {/* ×˜×‘×œ×ª ×”×©×§×¢×”/×¡×™×›×•×Ÿ/×›××•×ª */}
                            <div style={{display:'grid', gridTemplateColumns:'1fr 1fr 1fr', gap:10, marginTop:10}}>
                                 <div className="investment-highlight">
                                    <span style={{fontSize:'0.7rem', opacity:0.7}}>×¡×›×•× ×¡×™×›×•×Ÿ ($)</span>
                                    <input type="number" className="glass-input" style={{textAlign:'center', fontSize:'1rem', padding:5}} value={data.risk} onChange={e => handleInput('risk', e.target.value)} />
                                 </div>
                                 <div className="investment-highlight">
                                    <span style={{fontSize:'0.7rem', opacity:0.7}}>×›××•×ª (Coins)</span>
                                    <input type="number" className="glass-input" style={{textAlign:'center', fontSize:'1rem', padding:5}} value={data.amount} onChange={e => handleInput('amount', e.target.value)} />
                                 </div>
                                 <div className="investment-highlight">
                                    <span style={{fontSize:'0.7rem', opacity:0.7}}>×”×©×§×¢×” ($)</span>
                                    <div className="investment-val" style={{fontSize:'1rem'}}>${calcInvest.toFixed(2)}</div>
                                 </div>
                            </div>
            
                            <div style={{marginTop: 20, display: 'flex', alignItems: 'center', justifyContent: 'center', gap: 10, cursor: 'pointer', background: 'rgba(255,255,255,0.05)', padding: 8, borderRadius: 8}} onClick={() => setCreateAlerts(!createAlerts)}>
                                <div style={{
                                    width: 20, height: 20, borderRadius: 4, 
                                    border: '2px solid #00b894', 
                                    background: createAlerts ? '#00b894' : 'transparent',
                                    display: 'flex', alignItems: 'center', justifyContent: 'center'
                                }}>
                                    {createAlerts && <span style={{color:'white', fontWeight:'bold', fontSize:'0.8rem'}}>âœ“</span>}
                                </div>
                                <span style={{fontSize: '0.9rem'}}>ğŸ”” ×¦×•×¨ ×”×ª×¨××•×ª ××•×˜×•××˜×™×•×ª</span>
                            </div>
                            
                            {createAlerts && mode === 'add' && (
                                <div style={{textAlign:'center', fontSize:'0.75rem', color:'#00b894', marginTop:4, opacity: 0.8}}>
                                    {!parentSpot 
                                        ? "×™×™×•×•×¦×¨×• ×”×ª×¨××•×ª TP ×•-SL ×œ×¡×¤×•×˜"
                                        : `×™×™×•×•×¦×¨×• ×”×ª×¨××•×ª ×œ×’×™×“×•×¨ ${strategy.currentHedgeIndex}` + (strategy.calculatedSetups.length > strategy.currentHedgeIndex ? ` + ×›×•× × ×•×ª ×œ×’×™×“×•×¨ ×”×‘×` : "")
                                    }
                                </div>
                            )}
            
                            <div style={{ display: 'flex', gap: 10, marginTop: 20 }}>
                                <button onClick={handleSave} className="btn-action btn-add-spot" style={{ flex: 1 }}>
                                    {mode === 'add' ? '×©××•×¨ ×•×¦×•×¨' : '×¢×“×›×Ÿ'}
                                </button>
                                <button onClick={onClose} className="btn-action" style={{ flex: 1, background: '#333', color: '#ccc' }}>×‘×™×˜×•×œ</button>
                            </div>
                        </div>
                    </>
                );
            }
        File: RiskCalculator.tsx
            Code:
            // tradewall\src\components\RiskCalculator.tsx
            
            import React, { useState, useEffect } from 'react';
            
            type Prices = {
                [key: string]: number;
            };
            
            interface RiskCalculatorProps {
                prices: Prices;
            }
            
            const COINS = ['BTC', 'ETH', 'BNB', 'SOL'];
            
            export default function RiskCalculator({ prices }: RiskCalculatorProps) {
                // State ×¤× ×™××™ ×œ××—×©×‘×•×Ÿ - ×× ×•×ª×§ ××”×“×£ ×”×¨××©×™
                const [calcMode, setCalcMode] = useState<'long' | 'short'>('long');
                const [selectedCoin, setSelectedCoin] = useState<string>('BTC');
                const [inputs, setInputs] = useState({
                    risk: 50,
                    entry: '',
                    tp: '',
                    sl: ''
                });
            
                // ×¢×“×›×•×Ÿ ××•×˜×•××˜×™ ×©×œ ××—×™×¨ ×”×›× ×™×¡×” ×›×©×”××—×™×¨ ××©×ª× ×” (×× ×”×©×“×” ×¨×™×§)
                useEffect(() => {
                    if (!inputs.entry && prices[selectedCoin] > 0) {
                        setInputs(prev => ({ ...prev, entry: prices[selectedCoin].toString() }));
                    }
                }, [prices[selectedCoin], selectedCoin, inputs.entry]); 
            
                // ×œ×•×’×™×§×ª ×”×—×™×©×•×‘
                const runRiskCalc = () => {
                    const entry = parseFloat(inputs.entry);
                    const risk = inputs.risk;
                    const slPrice = parseFloat(inputs.sl);
                    const tpPrice = parseFloat(inputs.tp);
            
                    // ×—×™×©×•×‘ ×‘×¡×™×¡×™ ×“×•×¨×© ×›× ×™×¡×”, ×¡×™×›×•×Ÿ ×•×¡×˜×•×¤
                    if (!entry || !risk || !slPrice) return { posSize: 0, amount: 0, tpPercent: 0, slPercent: 0, expectedProfit: 0, expectedLoss: 0 };
            
                    const priceDiff = Math.abs(entry - slPrice);
                    if (priceDiff === 0) return { posSize: 0, amount: 0, tpPercent: 0, slPercent: 0, expectedProfit: 0, expectedLoss: 0 };
            
                    const amount = risk / priceDiff;
                    const posSize = amount * entry;
            
                    const tpPercent = tpPrice ? ((Math.abs(tpPrice - entry) / entry) * 100) : 0;
                    const slPercent = ((Math.abs(slPrice - entry) / entry) * 100);
            
                    // ×—×™×©×•×‘ ×¨×•×•×— ×•×”×¤×¡×“ ×“×•×œ×¨×™ ×¦×¤×•×™
                    const expectedProfit = tpPrice ? (amount * Math.abs(tpPrice - entry)) : 0;
                    // ×”×”×¤×¡×“ ×”×¦×¤×•×™ ×××•×¨ ×œ×”×™×•×ª ×©×•×•×” ×œ×¢×¨×š ×”×¡×™×›×•×Ÿ ×©×”×•×–×Ÿ, ××‘×œ × ×—×©×‘ ××•×ª×• ×›×“×™ ×œ×•×•×“× ×“×™×•×§ ××ª××˜×™
                    const expectedLoss = amount * Math.abs(slPrice - entry); 
            
                    return { posSize, amount, tpPercent, slPercent, expectedProfit, expectedLoss };
                };
            
                const results = runRiskCalc();
            
                return (
                    <div className="tab-content active">
                        <div className="calc-header">
                            <h2>× ×™×”×•×œ ×¡×™×›×•× ×™×</h2>
                            <p>×—×©×‘ ×’×•×“×œ ×¤×•×–×™×¦×™×” ×œ×¤×™ ×”×¡×™×›×•×Ÿ ×•××—×™×¨ ×¡×˜×•×¤</p>
                        </div>
            
                        <div className="coin-select-row">
                            {COINS.map(c => (
                                <button key={c} 
                                    className={`coin-btn ${selectedCoin === c ? 'active' : ''}`}
                                    onClick={() => {
                                        setSelectedCoin(c);
                                        setInputs(prev => ({...prev, entry: prices[c].toString()}));
                                    }}
                                >
                                    {c}
                                </button>
                            ))}
                        </div>
            
                        <div className="mode-toggle">
                            <button className={`mode-btn short ${calcMode === 'short' ? 'active' : ''}`} onClick={() => setCalcMode('short')}>SHORT ğŸ“‰</button>
                            <button className={`mode-btn long ${calcMode === 'long' ? 'active' : ''}`} onClick={() => setCalcMode('long')}>LONG ğŸ“ˆ</button>
                        </div>
            
                        <div style={{display:'flex', gap:15}}>
                            <div className="input-group" style={{flex:1}}>
                                <label>×¡×™×›×•×Ÿ ($) ××§×¡×™××œ×™</label>
                                <input type="number" className="glass-input" value={inputs.risk} 
                                    onChange={(e) => setInputs({...inputs, risk: parseFloat(e.target.value) || 0})} />
                            </div>
                            <div className="input-group" style={{flex:1}}>
                                <label>××—×™×¨ ×›× ×™×¡×” ($)</label>
                                <input type="number" className="glass-input" value={inputs.entry} 
                                    onChange={(e) => setInputs({...inputs, entry: e.target.value})} />
                            </div>
                        </div>
            
                        <div style={{display:'flex', gap:15}}>
                            <div className="input-group" style={{flex:1}}>
                                <label>××—×™×¨ ×™×¢×“ (TP $)</label>
                                <input type="number" className="glass-input" placeholder="××—×™×¨ ×™×¢×“" value={inputs.tp}
                                    onChange={(e) => setInputs({...inputs, tp: e.target.value})} />
                            </div>
                            <div className="input-group" style={{flex:1}}>
                                <label>××—×™×¨ ×¡×˜×•×¤ (SL $)</label>
                                <input type="number" className="glass-input" placeholder="××—×™×¨ ×¡×˜×•×¤" value={inputs.sl}
                                    onChange={(e) => setInputs({...inputs, sl: e.target.value})} />
                            </div>
                        </div>
            
                        <div className="calc-result-box">
                            <div className="res-top">
                                <div style={{textAlign:'right'}}>
                                    <span className="res-label">×’×•×“×œ ×¤×•×–×™×¦×™×” × ×“×¨×© (Total):</span>
                                    <div className="res-main-val">${results.posSize.toLocaleString(undefined, {maximumFractionDigits: 2})}</div>
                                </div>
                                <div style={{textAlign:'left'}}>
                                    <span className="res-label">×›××•×ª ××˜×‘×¢×•×ª ×œ×§× ×™×™×”:</span>
                                    <div className="res-sub-val">{results.amount.toFixed(4)} {selectedCoin}</div>
                                </div>
                            </div>
                            
                            <div className="res-grid">
                                <div className="res-item-small" style={{textAlign:'right'}}>
                                    <span className="res-label">Target Price</span>
                                    <div className="val" style={{color:'#00b894'}}>
                                        {inputs.tp ? `$${parseFloat(inputs.tp).toFixed(2)}` : '-'}
                                        {inputs.tp && <span style={{fontSize:'0.7em', opacity:0.7, marginRight: 5}}>({results.tpPercent.toFixed(2)}%)</span>}
                                    </div>
                                    {/* ×ª×¦×•×’×ª ×¨×•×•×— ×¦×¤×•×™ */}
                                    {results.expectedProfit > 0 && (
                                        <div style={{color: '#00b894', fontSize: '0.85em', marginTop: '4px', opacity: 0.9}}>
                                            ×¨×•×•×— ×¦×¤×•×™: +${results.expectedProfit.toLocaleString(undefined, {maximumFractionDigits: 2})}
                                        </div>
                                    )}
                                </div>
                                <div className="res-item-small" style={{textAlign:'left'}}>
                                    <span className="res-label">Stop Price</span>
                                    <div className="val" style={{color:'#ff7675'}}>
                                        {inputs.sl ? `$${parseFloat(inputs.sl).toFixed(2)}` : '-'}
                                        {inputs.sl && <span style={{fontSize:'0.7em', opacity:0.7, marginRight: 5}}>({results.slPercent.toFixed(2)}%)</span>}
                                    </div>
                                    {/* ×ª×¦×•×’×ª ×”×¤×¡×“ ×¦×¤×•×™ */}
                                    {results.expectedLoss > 0 && (
                                        <div style={{color: '#ff7675', fontSize: '0.85em', marginTop: '4px', opacity: 0.9}}>
                                            ×”×¤×¡×“ ×¦×¤×•×™: -${results.expectedLoss.toLocaleString(undefined, {maximumFractionDigits: 2})}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

    Folder: lib
        File: supabaseClient.ts
            Code:
            // tradewall/src/lib/supabaseClient.ts
            
            import { createClient } from '@supabase/supabase-js'
            
            const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL
            const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY
            
            if (!supabaseUrl || !supabaseAnonKey) {
              throw new Error('Missing Supabase environment variables')
            }
            
            // ×©×™× ×œ×‘ ×œ-export ×›××Ÿ
            export const supabase = createClient(supabaseUrl, supabaseAnonKey)

